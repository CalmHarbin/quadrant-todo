<template>
  <n-config-provider>
    <n-message-provider>
      <n-dialog-provider>
        <div class="app" :data-theme="isDark ? 'dark' : 'light'">
          <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
          <div class="toolbar">
            <div class="toolbar-left">
              <h1 class="app-title">ÂõõË±°Èôê TODO</h1>
            </div>
            <div class="toolbar-right">
              <!-- TODO: Ê∑ªÂä†ÊêúÁ¥¢„ÄÅËÆæÁΩÆÁ≠âÂäüËÉΩÊåâÈíÆ -->
              <n-button 
                quaternary 
                circle 
                @click="showCompletedModal = true"
                title="Â∑≤ÂÆåÊàêÁöÑÂæÖÂäû"
              >
                üìã
              </n-button>
              <n-button 
                quaternary 
                circle 
                @click="showDataManageModal = true"
                title="Êï∞ÊçÆÁÆ°ÁêÜ"
              >
                üìÅ
              </n-button>
              <n-button 
                quaternary 
                circle 
                @click="showSettingsModal = true"
                title="ËÆæÁΩÆ"
              >
                ‚öôÔ∏è
              </n-button>
              <n-button 
                quaternary 
                circle 
                @click="toggleTheme"
              >
                {{ isDark ? '‚òÄÔ∏è' : 'üåô' }}
              </n-button>
            </div>
          </div>

          <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
          <div class="main-content">
            <!-- ÂõõË±°ÈôêÁΩëÊ†º -->
            <div class="quadrant-grid">
              <!-- ÈáçË¶Å‰∏îÁ¥ßÊÄ• -->
              <div class="quadrant urgent-important" 
                   :class="{ 'drag-over': dragOverQuadrant === 'urgent-important' }"
                   @dragenter="dragOverQuadrant = 'urgent-important'"
                   @dragleave="handleDragLeave"
                   @dragover="handleDragOver($event)"
                   @drop="handleQuadrantDrop('urgent-important', $event)">
                <div class="quadrant-header">
                  <h2>ÈáçË¶Å‰∏îÁ¥ßÊÄ•</h2>
                  <n-button size="medium" quaternary @click="openAddModal('urgent-important')" class="add-button">
                    ‚úö
                  </n-button>
                </div>
                <div class="memo-list">
                  <div 
                    v-for="(memo, index) in getQuadrantMemos('urgent-important')" 
                    :key="memo.id"
                    class="memo-card urgent-important-card"
                    :class="{ 'completed': memo.completed, 'dragging': draggedMemo?.id === memo.id, 'long-pressed': currentPressedMemo?.id === memo.id && isDraggable }"
                    draggable="true"
                    @dragstart="handleDragStart(memo, $event)"
                    @drag="handleDrag"
                    @dragover="handleDragOver($event)"
                    @dragenter="handleDragEnter($event)"
                    @drop="handleDrop(memo, 'urgent-important', $event)"
                    @dragend="handleDragEnd()"
                    @mousedown="handleMouseDown(memo, $event)"
                    @mouseup="handleMouseUp()"
                    @dblclick="openEditModal(memo)"
                  >
                    <div class="memo-header">
                      <n-checkbox 
                        :checked="memo.completed"
                        @update:checked="(checked) => toggleMemoComplete(memo.id, checked)"
                        @click.stop
                        @mousedown.stop
                        @dragstart.stop
                      />
                      <div class="memo-title" :class="{ 'completed-text': memo.completed }">
                        {{ memo.title }}
                      </div>
                    </div>
                    <div class="memo-actions">
                      <n-dropdown trigger="hover" :options="getMoveOptions(memo)" @select="handleMoveToQuadrant">
                        <n-button 
                          size="tiny" 
                          quaternary 
                          type="info"
                          @click.stop
                          @mousedown.stop
                        >
                          ÁßªÂä®
                        </n-button>
                      </n-dropdown>
                      <n-button 
                        size="tiny" 
                        quaternary 
                        type="error"
                        @click.stop="deleteMemo(memo.id)"
                        @mousedown.stop
                        @dragstart.stop
                      >
                        √ó
                      </n-button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ÈáçË¶Å‰∏çÁ¥ßÊÄ• -->
              <div class="quadrant important-not-urgent"
                   :class="{ 'drag-over': dragOverQuadrant === 'important-not-urgent' }"
                   @dragenter="dragOverQuadrant = 'important-not-urgent'"
                   @dragleave="handleDragLeave"
                   @dragover="handleDragOver($event)"
                   @drop="handleQuadrantDrop('important-not-urgent', $event)">
                <div class="quadrant-header">
                  <h2>ÈáçË¶Å‰∏çÁ¥ßÊÄ•</h2>
                  <n-button size="medium" quaternary @click="openAddModal('important-not-urgent')" class="add-button">
                    ‚úö
                  </n-button>
                </div>
                <div class="memo-list">
                  <div 
                    v-for="(memo, index) in getQuadrantMemos('important-not-urgent')" 
                    :key="memo.id"
                    class="memo-card important-not-urgent-card"
                    :class="{ 'completed': memo.completed, 'dragging': draggedMemo?.id === memo.id, 'long-pressed': currentPressedMemo?.id === memo.id && isDraggable }"
                    draggable="true"
                    @dragstart="handleDragStart(memo, $event)"
                    @dragover="handleDragOver($event)"
                    @drop="handleDrop(memo, 'important-not-urgent', $event)"
                    @dragend="handleDragEnd()"
                    @mousedown="handleMouseDown(memo, $event)"
                    @mouseup="handleMouseUp()"
                    @dblclick="openEditModal(memo)"
                  >
                    <div class="memo-header">
                      <n-checkbox 
                        :checked="memo.completed"
                        @update:checked="(checked) => toggleMemoComplete(memo.id, checked)"
                        @click.stop
                      />
                      <div class="memo-title" :class="{ 'completed-text': memo.completed }">
                        {{ memo.title }}
                      </div>
                    </div>
                    <div class="memo-actions">
                      <n-dropdown trigger="hover" :options="getMoveOptions(memo)" @select="handleMoveToQuadrant">
                        <n-button 
                          size="tiny" 
                          quaternary 
                          type="info"
                          @click.stop
                          @mousedown.stop
                        >
                          ÁßªÂä®
                        </n-button>
                      </n-dropdown>
                      <n-button 
                        size="tiny" 
                        quaternary 
                        type="error"
                        @click.stop="deleteMemo(memo.id)"
                        @mousedown.stop
                        @dragstart.stop
                      >
                        √ó
                      </n-button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Á¥ßÊÄ•‰∏çÈáçË¶Å -->
              <div class="quadrant urgent-not-important"
                   :class="{ 'drag-over': dragOverQuadrant === 'urgent-not-important' }"
                   @dragenter="dragOverQuadrant = 'urgent-not-important'"
                   @dragleave="handleDragLeave"
                   @dragover="handleDragOver($event)"
                   @drop="handleQuadrantDrop('urgent-not-important', $event)">
                <div class="quadrant-header">
                  <h2>Á¥ßÊÄ•‰∏çÈáçË¶Å</h2>
                  <n-button size="medium" quaternary @click="openAddModal('urgent-not-important')" class="add-button">
                    ‚úö
                  </n-button>
                </div>
                <div class="memo-list">
                  <div 
                    v-for="(memo, index) in getQuadrantMemos('urgent-not-important')" 
                    :key="memo.id"
                    class="memo-card urgent-not-important-card"
                    :class="{ 'completed': memo.completed, 'dragging': draggedMemo?.id === memo.id, 'long-pressed': currentPressedMemo?.id === memo.id && isDraggable }"
                    draggable="true"
                    @dragstart="handleDragStart(memo, $event)"
                    @dragover="handleDragOver($event)"
                    @drop="handleDrop(memo, 'urgent-not-important', $event)"
                    @dragend="handleDragEnd()"
                    @mousedown="handleMouseDown(memo, $event)"
                    @mouseup="handleMouseUp()"
                    @dblclick="openEditModal(memo)"
                  >
                    <div class="memo-header">
                      <n-checkbox 
                        :checked="memo.completed"
                        @update:checked="(checked) => toggleMemoComplete(memo.id, checked)"
                        @click.stop
                      />
                      <div class="memo-title" :class="{ 'completed-text': memo.completed }">
                        {{ memo.title }}
                      </div>
                    </div>
                    <div class="memo-actions">
                      <n-dropdown trigger="hover" :options="getMoveOptions(memo)" @select="handleMoveToQuadrant">
                        <n-button 
                          size="tiny" 
                          quaternary 
                          type="info"
                          @click.stop
                          @mousedown.stop
                        >
                          ÁßªÂä®
                        </n-button>
                      </n-dropdown>
                      <n-button 
                        size="tiny" 
                        quaternary 
                        type="error"
                        @click.stop="deleteMemo(memo.id)"
                        @mousedown.stop
                        @dragstart.stop
                      >
                        √ó
                      </n-button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ• -->
              <div class="quadrant not-urgent-not-important"
                   :class="{ 'drag-over': dragOverQuadrant === 'not-urgent-not-important' }"
                   @dragenter="dragOverQuadrant = 'not-urgent-not-important'"
                   @dragleave="handleDragLeave"
                   @dragover="handleDragOver($event)"
                   @drop="handleQuadrantDrop('not-urgent-not-important', $event)">
                <div class="quadrant-header">
                  <h2>‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ•</h2>
                  <n-button size="medium" quaternary @click="openAddModal('not-urgent-not-important')" class="add-button">
                    ‚úö
                  </n-button>
                </div>
                <div class="memo-list">
                  <div 
                    v-for="(memo, index) in getQuadrantMemos('not-urgent-not-important')" 
                    :key="memo.id"
                    class="memo-card not-urgent-not-important-card"
                    :class="{ 'completed': memo.completed, 'dragging': draggedMemo?.id === memo.id, 'long-pressed': currentPressedMemo?.id === memo.id && isDraggable }"
                    draggable="true"
                    @dragstart="handleDragStart(memo, $event)"
                    @dragover="handleDragOver($event)"
                    @drop="handleDrop(memo, 'not-urgent-not-important', $event)"
                    @dragend="handleDragEnd()"
                    @mousedown="handleMouseDown(memo, $event)"
                    @mouseup="handleMouseUp()"
                    @dblclick="openEditModal(memo)"
                  >
                    <div class="memo-header">
                      <n-checkbox 
                        :checked="memo.completed"
                        @update:checked="(checked) => toggleMemoComplete(memo.id, checked)"
                        @click.stop
                      />
                      <div class="memo-title" :class="{ 'completed-text': memo.completed }">
                        {{ memo.title }}
                      </div>
                    </div>
                    <div class="memo-actions">
                      <n-dropdown trigger="hover" :options="getMoveOptions(memo)" @select="handleMoveToQuadrant">
                        <n-button 
                          size="tiny" 
                          quaternary 
                          type="info"
                          @click.stop
                          @mousedown.stop
                        >
                          ÁßªÂä®
                        </n-button>
                      </n-dropdown>
                      <n-button 
                        size="tiny" 
                        quaternary 
                        type="error"
                        @click.stop="deleteMemo(memo.id)"
                        @mousedown.stop
                        @dragstart.stop
                      >
                        √ó
                      </n-button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ÁºñËæë/Êñ∞Â¢û Modal -->
          <n-modal v-model:show="showModal" preset="card" style="width: 800px; max-width: 90vw;">
            <template #header>
              <span>{{ isEditing ? 'ÁºñËæëÂ§áÂøòÂΩï' : 'Êñ∞Â¢ûÂ§áÂøòÂΩï' }}</span>
            </template>
            
            <div class="modal-content">
              <n-form ref="formRef" :model="currentMemo" :rules="formRules">
                <n-form-item label="Ê†áÈ¢ò" path="title">
                  <n-input 
                    v-model:value="currentMemo.title" 
                    placeholder="ËØ∑ËæìÂÖ•Ê†áÈ¢òÔºàÊúÄÂ§ö50‰∏™Â≠óÁ¨¶Ôºâ"
                    clearable
                    maxlength="50"
                    show-count
                  />
                </n-form-item>
                
                <n-form-item label="Ë±°Èôê" path="quadrant" v-if="isEditing">
                  <n-select 
                    v-model:value="currentMemo.quadrant" 
                    :options="quadrantOptions"
                    placeholder="ÈÄâÊã©Ë±°Èôê"
                  />
                </n-form-item>
                
                <n-form-item label="ÂÜÖÂÆπ" path="content">
                  <div class="rich-editor-container">
                    <div 
                      ref="editorRef"
                      class="rich-editor"
                      contenteditable="true"
                      @input="handleEditorInput"
                      @paste="handlePaste"
                      @focus="handleEditorFocus"
                    ></div>
                    <div class="editor-toolbar">
                      <small>ÊîØÊåÅÁõ¥Êé•Á≤òË¥¥ÂõæÁâáÔºåÂõæÁâáÂ∞Ü‰øùÂ≠òÂú®Êú¨Âú∞</small>
                    </div>
                  </div>
                </n-form-item>
              </n-form>
            </div>
            
            <template #footer>
              <div class="modal-footer">
                <n-button @click="showModal = false">ÂèñÊ∂à</n-button>
                <n-button type="primary" @click="saveMemo">
                  {{ isEditing ? 'Êõ¥Êñ∞' : '‰øùÂ≠ò' }}
                </n-button>
              </div>
            </template>
          </n-modal>

          <!-- Êï∞ÊçÆÁÆ°ÁêÜ Modal -->
          <n-modal v-model:show="showDataManageModal" preset="card" style="width: 500px; max-width: 90vw; max-height: 80vh;">
            <template #header>
              <span>üìÅ Êï∞ÊçÆÁÆ°ÁêÜ</span>
            </template>
            
            <div class="data-manage-content custom-scrollbar" style="max-height: 60vh; overflow-y: auto;">
              <n-space vertical size="medium">
                <!-- Êï∞ÊçÆÂØºÂá∫ -->
                <div class="data-section">
                  <h3>üì§ Êï∞ÊçÆÂØºÂá∫</h3>
                  <p>Â∞ÜÊÇ®ÁöÑÊâÄÊúâ TODO Êï∞ÊçÆÂíåÂõæÁâáÂØºÂá∫‰∏∫ÂéãÁº©ÂåÖÔºåÂÆåÊï¥Â§á‰ªΩÂíåËøÅÁßª„ÄÇ</p>
                  <n-space>
                    <n-button type="primary" @click="exportPackage">
                      üì¶ ÂØºÂá∫ÂéãÁº©ÂåÖ
                    </n-button>
                  </n-space>
                </div>

                <n-divider />

                <!-- Êï∞ÊçÆÂØºÂÖ• -->
                <div class="data-section">
                  <h3>üì• Êï∞ÊçÆÂØºÂÖ•</h3>
                  <p>‰ªéÂéãÁº©ÂåÖ‰∏≠ÊÅ¢Â§çÊï∞ÊçÆÔºåÊîØÊåÅÂõæÁâáÊÅ¢Â§ç„ÄÇ</p>
                  <n-space>
                    <n-upload
                      :show-file-list="false"
                      @before-upload="handlePackageUpload"
                      accept=".zip,.rar,.7z"
                    >
                      <n-button type="primary">üì¶ ÂØºÂÖ•ÂéãÁº©ÂåÖ</n-button>
                    </n-upload>
                  </n-space>
                </div>

                <n-divider />

                <!-- Êï∞ÊçÆÁªüËÆ° -->
                <div class="data-section">
                  <h3>üìä Êï∞ÊçÆÁªüËÆ°</h3>
                  <n-space>
                    <n-statistic label="ÊÄªÂ§áÂøòÂΩïÊï∞" :value="memos.length" />
                    <n-statistic label="ÈáçË¶Å‰∏îÁ¥ßÊÄ•" :value="getQuadrantMemos('urgent-important').length" />
                    <n-statistic label="ÈáçË¶Å‰∏çÁ¥ßÊÄ•" :value="getQuadrantMemos('important-not-urgent').length" />
                    <n-statistic label="Á¥ßÊÄ•‰∏çÈáçË¶Å" :value="getQuadrantMemos('urgent-not-important').length" />
                    <n-statistic label="‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ•" :value="getQuadrantMemos('not-urgent-not-important').length" />
                  </n-space>
                </div>

                <n-divider />

                <!-- ÂõæÁâáÊ∏ÖÁêÜ -->
                <div class="data-section">
                  <h3>üñºÔ∏è ÂõæÁâáÊ∏ÖÁêÜ</h3>
                  <p>Ê∏ÖÁêÜÊú™Ë¢´‰ΩøÁî®ÁöÑÂõæÁâáÊñá‰ª∂ÔºåÈáäÊîæÂ≠òÂÇ®Á©∫Èó¥„ÄÇÂª∫ËÆÆÂÆöÊúüÊâßË°åÊ≠§Êìç‰Ωú„ÄÇ</p>
                  <n-button @click="cleanupUnusedImages">
                    üßπ Ê∏ÖÁêÜÊó†Áî®ÂõæÁâá
                  </n-button>
                </div>

                <n-divider />

                <!-- Âç±Èô©Êìç‰Ωú -->
                <div class="data-section danger-section">
                  <h3>‚ö†Ô∏è Âç±Èô©Êìç‰Ωú</h3>
                  <p>ËØ∑Ë∞®ÊÖéÊìç‰ΩúÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§èÔºÅ</p>
                  <n-button 
                    type="error" 
                    @click="confirmClearData"
                    secondary
                  >
                    üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
                  </n-button>
                </div>
              </n-space>
            </div>
            
            <template #footer>
              <div class="modal-footer">
                <n-button @click="showDataManageModal = false">ÂÖ≥Èó≠</n-button>
              </div>
            </template>
          </n-modal>

          <!-- Â∑≤ÂÆåÊàêÂæÖÂäû Modal -->
          <n-modal v-model:show="showCompletedModal" preset="card" style="width: 800px; max-width: 90vw;">
            <template #header>
              <span>üìã Â∑≤ÂÆåÊàêÁöÑÂæÖÂäû</span>
            </template>
            
            <div class="completed-memo-content">
              <div v-if="getCompletedMemos().length === 0" class="empty-state">
                <div class="empty-icon">‚úì</div>
                <p>ËøòÊ≤°ÊúâÂ∑≤ÂÆåÊàêÁöÑÂæÖÂäû</p>
              </div>
              <div v-else class="completed-memo-list">
                <div 
                  v-for="memo in getCompletedMemos()" 
                  :key="memo.id"
                  class="completed-memo-item"
                  @dblclick="viewCompletedMemoDetail(memo)"
                >
                  <div class="completed-memo-header">
                    <div class="completed-memo-title">{{ memo.title }}</div>
                    <div class="completed-memo-meta">
                      <span class="quadrant-tag" :class="memo.quadrant">{{ getQuadrantName(memo.quadrant) }}</span>
                      <span class="completed-time">{{ formatCompletedTime(memo.completedTime) }}</span>
                    </div>
                  </div>
                  <div class="completed-memo-actions">
                    <n-button 
                      size="small" 
                      @click="uncompleteTask(memo.id)"
                      type="warning"
                      secondary
                    >
                      ÊÅ¢Â§ç
                    </n-button>
                    <n-button 
                      size="small" 
                      @click="deleteCompletedMemo(memo.id)"
                      type="error"
                      secondary
                    >
                      Âà†Èô§
                    </n-button>
                  </div>
                </div>
              </div>
            </div>
            
            <template #footer>
              <div class="modal-footer">
                <n-button @click="showCompletedModal = false">ÂÖ≥Èó≠</n-button>
                <n-button 
                  v-if="getCompletedMemos().length > 0"
                  @click="clearCompletedMemos"
                  type="error"
                  secondary
                >
                  Ê∏ÖÁ©∫Â∑≤ÂÆåÊàê
                </n-button>
              </div>
            </template>
          </n-modal>
          
          <!-- Â∑≤ÂÆåÊàêÂæÖÂäûËØ¶ÊÉÖ Modal -->
          <n-modal v-model:show="showCompletedDetailModal" preset="card" style="width: 700px; max-width: 90vw;">
            <template #header>
              <span>üìã Â∑≤ÂÆåÊàêÂæÖÂäûËØ¶ÊÉÖ</span>
            </template>
            
            <div class="completed-detail-content" v-if="selectedCompletedMemo">
              <div class="detail-section">
                <h4>Ê†áÈ¢ò</h4>
                <p class="detail-title">{{ selectedCompletedMemo.title }}</p>
              </div>
              
              <div class="detail-section">
                <h4>Ë±°Èôê</h4>
                <span class="quadrant-tag" :class="selectedCompletedMemo.quadrant">
                  {{ getQuadrantName(selectedCompletedMemo.quadrant) }}
                </span>
              </div>
              
              <div class="detail-section">
                <h4>ÂÆåÊàêÊó∂Èó¥</h4>
                <p class="detail-time">{{ formatCompletedTime(selectedCompletedMemo.completedTime) }}</p>
              </div>
              
              <div class="detail-section" v-if="selectedCompletedMemo.content">
                <h4>ÂÜÖÂÆπËØ¶ÊÉÖ</h4>
                <div class="detail-content" v-html="selectedCompletedMemo.content"></div>
              </div>
              
              <div class="detail-section" v-if="selectedCompletedMemo.created">
                <h4>ÂàõÂª∫Êó∂Èó¥</h4>
                <p class="detail-created">{{ formatCreatedTime(selectedCompletedMemo.created) }}</p>
              </div>
            </div>
            
            <template #footer>
              <div class="modal-footer">
                <n-button @click="showCompletedDetailModal = false">ÂÖ≥Èó≠</n-button>
                <n-button 
                  v-if="selectedCompletedMemo"
                  @click="uncompleteTaskFromDetail"
                  type="warning"
                  secondary
                >
                  ÊÅ¢Â§ç‰∏∫Êú™ÂÆåÊàê
                </n-button>
              </div>
            </template>
          </n-modal>
          
          <!-- ËÆæÁΩÆ Modal -->
          <n-modal v-model:show="showSettingsModal" preset="card" style="width: 600px; max-width: 90vw;">
            <template #header>
              <span>‚öôÔ∏è Â∫îÁî®ËÆæÁΩÆ</span>
            </template>
            
            <div class="settings-content">
              <n-space vertical size="large">
                <!-- ÁâàÊú¨‰ø°ÊÅØ -->
                <div class="settings-section">
                  <h3>üìü ÁâàÊú¨‰ø°ÊÅØ</h3>
                  <div class="version-info">
                    <p><strong>Â∫îÁî®ÂêçÁß∞Ôºö</strong>ÂõõË±°ÈôêTODO</p>
                    <p><strong>Â∫îÁî®ÁâàÊú¨Ôºö</strong>{{ appVersion }}</p>
                    <p><strong>ÊûÑÂª∫Êó∂Èó¥Ôºö</strong>{{ buildTime }}</p>
                  </div>
                </div>

                <n-divider />

                <!-- Êï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï -->
                <div class="settings-section">
                  <h3>üìÅ Êï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï</h3>
                  <div class="data-path-section">
                    <p><strong>ÂΩìÂâçÁõÆÂΩïÔºö</strong></p>
                    <div class="current-path">
                      <n-input 
                        :value="currentDataPath" 
                        readonly 
                        placeholder="Ëé∑Âèñ‰∏≠..."
                      />
                    </div>
                    <n-space style="margin-top: 12px;">
                      <n-button @click="selectNewDataDirectory">
                        üìÇ ÈÄâÊã©Êñ∞ÁõÆÂΩï
                      </n-button>
                      <n-button @click="openDataDirectory" v-if="currentDataPath">
                        üñºÔ∏è ÊâìÂºÄÁõÆÂΩï
                      </n-button>
                    </n-space>
                    <p class="setting-description">
                      ÊÇ®ÂèØ‰ª•Êõ¥ÊîπÊï∞ÊçÆÂ≠òÂÇ®‰ΩçÁΩÆÔºåÊï∞ÊçÆÂ∞ÜË¢´ËøÅÁßªÂà∞Êñ∞‰ΩçÁΩÆ„ÄÇ
                    </p>
                  </div>
                </div>
              </n-space>
            </div>
            
            <template #footer>
              <div class="modal-footer">
                <n-button @click="showSettingsModal = false">ÂÖ≥Èó≠</n-button>
              </div>
            </template>
          </n-modal>
        </div>
      </n-dialog-provider>
    </n-message-provider>
  </n-config-provider>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { 
  NConfigProvider,
  NMessageProvider,
  NDialogProvider,
  NButton, 
  NModal, 
  NForm, 
  NFormItem, 
  NInput, 
  NSelect,
  NSpace,
  NDivider,
  NStatistic,
  NUpload,
  NCheckbox,
  NDropdown
} from 'naive-ui'
// ‰∏¥Êó∂‰ΩøÁî®ÊñáÊú¨ÂõæÊ†áÊõø‰ª£ÔºåÈÅøÂÖçÂØºÂÖ•ÈóÆÈ¢ò
// import { 
//   Add as AddIcon, 
//   Trash as DeleteIcon,
//   Moon as MoonIcon,
//   Sunny as SunIcon
// } from '@vicons/ionicons5'

// TODO: Á±ªÂûãÂÆö‰πâÂ∫îËØ•ÊîæÂú®ÂçïÁã¨ÁöÑÁ±ªÂûãÊñá‰ª∂‰∏≠
interface Memo {
  id?: number
  title: string
  content: string
  quadrant: string
  created?: number
  completed?: boolean
  completedTime?: number
  sortOrder?: number
}

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const memos = ref<Memo[]>([])
const showModal = ref(false)
const isEditing = ref(false)
const isDark = ref(false)
const showDataManageModal = ref(false)
const draggedMemo = ref<Memo | null>(null)
const dragOverQuadrant = ref<string | null>(null)
const autoScrollInterval = ref<number | null>(null)
const isDraggable = ref(false)
const currentPressedMemo = ref<Memo | null>(null)
const pressTimer = ref<number | null>(null)
const editorRef = ref<HTMLElement | null>(null)
const showCompletedModal = ref(false)
const showCompletedDetailModal = ref(false)
const selectedCompletedMemo = ref<Memo | null>(null)
const completedMemos = ref<Memo[]>([])
const showSettingsModal = ref(false)
const currentDataPath = ref('')
const appVersion = ref('1.0.0')
const buildTime = ref('')

const currentMemo = reactive<Memo>({
  title: '',
  content: '',
  quadrant: 'urgent-important',
  completed: false
})

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const formRules = {
  title: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Ê†áÈ¢ò', trigger: 'blur' },
    { max: 50, message: 'Ê†áÈ¢ò‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶', trigger: 'blur' }
  ],
  quadrant: [
    { required: true, message: 'ËØ∑ÈÄâÊã©Ë±°Èôê', trigger: 'change' }
  ]
}

// Ë±°ÈôêÈÄâÈ°π
const quadrantOptions = [
  { label: 'ÈáçË¶Å‰∏îÁ¥ßÊÄ•', value: 'urgent-important' },
  { label: 'ÈáçË¶Å‰∏çÁ¥ßÊÄ•', value: 'important-not-urgent' },
  { label: 'Á¥ßÊÄ•‰∏çÈáçË¶Å', value: 'urgent-not-important' },
  { label: '‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ•', value: 'not-urgent-not-important' }
]

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊ†πÊçÆË±°ÈôêËé∑ÂèñÂ§áÂøòÂΩï
const getQuadrantMemos = (quadrant: string) => {
  const now = Date.now()
  const oneDayAgo = now - (24 * 60 * 60 * 1000) // 24Â∞èÊó∂Ââç
  
  return memos.value
    .filter(memo => {
      // ËøáÊª§Ë±°Èôê
      if (memo.quadrant !== quadrant) return false
      
      // Â¶ÇÊûúÊòØÂ∑≤ÂÆåÊàêÁöÑÂæÖÂäûÔºå‰∏îÂÆåÊàêÊó∂Èó¥Ë∂ÖËøá24Â∞èÊó∂ÔºåÂàô‰∏çÂú®‰∏ªÈ°µÈù¢Â±ïÁ§∫
      if (memo.completed && memo.completedTime && memo.completedTime < oneDayAgo) {
        return false
      }
      
      return true
    })
    .sort((a, b) => {
      // ÊåâÊéíÂ∫èÈ°∫Â∫èÊéíÂàóÔºåÂ¶ÇÊûúÊ≤°ÊúâÊéíÂ∫èÂàôÊåâÂàõÂª∫Êó∂Èó¥ÂÄíÂ∫èÊéíÂàóÔºàÊñ∞ÁöÑÂú®ÂâçÔºâ
      if (a.sortOrder !== undefined && b.sortOrder !== undefined) {
        return a.sortOrder - b.sortOrder
      }
      if (a.sortOrder !== undefined) return -1
      if (b.sortOrder !== undefined) return 1
      return (b.created || 0) - (a.created || 0)  // Êîπ‰∏∫ÂÄíÂ∫èÔºåÊñ∞ÁöÑÂú®Ââç
    })
}

// ‰∏ªÈ¢òÂàáÊç¢
const toggleTheme = () => {
  isDark.value = !isDark.value
  // TODO: ‰øùÂ≠ò‰∏ªÈ¢òËÆæÁΩÆÂà∞Êú¨Âú∞Â≠òÂÇ®
  localStorage.setItem('theme', isDark.value ? 'dark' : 'light')
}

// Èº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂Â§ÑÁêÜ
const handleMouseDown = (memo: Memo, event: MouseEvent) => {
  // ‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåËÆ©ÊãñÊãΩËÉΩÊ≠£Â∏∏ÂºÄÂßã
  currentPressedMemo.value = memo
  
  // ËÆæÁΩÆÈïøÊåâÂÆöÊó∂Âô®Ôºà300msÂêéÊòæÁ§∫ËßÜËßâÂèçÈ¶àÔºâ
  pressTimer.value = setTimeout(() => {
    if (currentPressedMemo.value?.id === memo.id) {
      isDraggable.value = true
    }
  }, 300) as any
}

// Èº†Ê†áÊùæÂºÄ‰∫ã‰ª∂Â§ÑÁêÜ
const handleMouseUp = () => {
  // Ê∏ÖÈô§ÂÆöÊó∂Âô®
  if (pressTimer.value) {
    clearTimeout(pressTimer.value)
    pressTimer.value = null
  }
  
  // ÈáçÁΩÆÁä∂ÊÄÅ
  currentPressedMemo.value = null
  
  // Âª∂ËøüÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅÔºåÁªôÊãñÊãΩÊìç‰ΩúÊó∂Èó¥
  setTimeout(() => {
    if (!draggedMemo.value) {
      isDraggable.value = false
    }
  }, 100)
}

// ÊãñÊãΩÂºÄÂßã
const handleDragStart = (memo: Memo, event: DragEvent) => {
  console.log('ÊãñÊãΩÂºÄÂßã:', memo.title) // Ë∞ÉËØïÊó•Âøó
  
  draggedMemo.value = memo
  isDraggable.value = true
  
  if (event.dataTransfer) {
    event.dataTransfer.effectAllowed = 'move'
    event.dataTransfer.setData('text/plain', memo.id?.toString() || '')
    
    // ‰ºòÂåñÊãñÊãΩÂõæÂÉè
    try {
      const dragElement = document.createElement('div')
      dragElement.textContent = memo.title.length > 15 ? memo.title.substring(0, 15) + '...' : memo.title
      dragElement.style.cssText = `
        position: absolute;
        top: -1000px;
        left: -1000px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        pointer-events: none;
        z-index: 9999;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      `
      document.body.appendChild(dragElement)
      
      event.dataTransfer.setDragImage(dragElement, 80, 20)
      
      setTimeout(() => {
        if (document.body.contains(dragElement)) {
          document.body.removeChild(dragElement)
        }
      }, 100)
    } catch (error) {
      console.log('ËÆæÁΩÆÊãñÊãΩÂõæÂÉèÂ§±Ë¥•:', error)
    }
  }
}

// ÊãñÊãΩËøáÁ®ã‰∏≠
const handleDrag = (event: DragEvent) => {
  // Ê≠§‰∫ã‰ª∂Âú®ÊãñÊãΩËøáÁ®ã‰∏≠ÊåÅÁª≠Ëß¶Âèë
  console.log('ÊãñÊãΩ‰∏≠...', event.clientX, event.clientY)
}

// ÊãñÊãΩËøõÂÖ•
const handleDragEnter = (event: DragEvent) => {
  event.preventDefault()
  console.log('ÊãñÊãΩËøõÂÖ•')
}

// ÊãñÊãΩÁªèËøá
const handleDragOver = (event: DragEvent) => {
  event.preventDefault()
  if (event.dataTransfer) {
    event.dataTransfer.dropEffect = 'move'
  }
  
  // Ëá™Âä®ÊªöÂä®ÂäüËÉΩ
  const target = event.currentTarget as HTMLElement
  const memoList = target.closest('.memo-list') as HTMLElement
  if (memoList) {
    const rect = memoList.getBoundingClientRect()
    const scrollThreshold = 50
    const scrollSpeed = 10
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑËá™Âä®ÊªöÂä®
    if (autoScrollInterval.value) {
      clearInterval(autoScrollInterval.value)
      autoScrollInterval.value = null
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂêë‰∏äÊªöÂä®
    if (event.clientY - rect.top < scrollThreshold) {
      autoScrollInterval.value = setInterval(() => {
        memoList.scrollTop = Math.max(0, memoList.scrollTop - scrollSpeed)
      }, 16) as any
    }
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂêë‰∏ãÊªöÂä®
    else if (rect.bottom - event.clientY < scrollThreshold) {
      autoScrollInterval.value = setInterval(() => {
        memoList.scrollTop = Math.min(
          memoList.scrollHeight - memoList.clientHeight,
          memoList.scrollTop + scrollSpeed
        )
      }, 16) as any
    }
  }
}

// ÊîæÁΩÆ
const handleDrop = async (targetMemo: Memo, targetQuadrant: string, event: DragEvent) => {
  event.preventDefault()
  event.stopPropagation()
  console.log('ÊîæÁΩÆ‰∫ã‰ª∂:', targetMemo.title, targetQuadrant)
  
  if (!draggedMemo.value || draggedMemo.value.id === targetMemo.id) {
    console.log('ÊãñÊãΩÂèñÊ∂àÊàñÁõÆÊ†áÁõ∏Âêå')
    return
  }
  
  const sourceQuadrant = draggedMemo.value.quadrant
  const targetMemos = getQuadrantMemos(targetQuadrant)
  const targetIndex = targetMemos.findIndex(m => m.id === targetMemo.id)
  
  try {
    // 1. ÂÖàÊõ¥Êñ∞Ë±°ÈôêÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
    if (sourceQuadrant !== targetQuadrant) {
      await updateMemoQuadrant(draggedMemo.value.id!, targetQuadrant)
      console.log('Â∑≤Êõ¥Êñ∞Ë±°Èôê:', sourceQuadrant, '->', targetQuadrant)
    }
    
    // 2. ÂÜçÊõ¥Êñ∞ÊéíÂ∫è
    await updateMemosOrder(targetQuadrant, draggedMemo.value.id!, targetIndex)
    console.log('Â∑≤Êõ¥Êñ∞ÊéíÂ∫èÂú®‰ΩçÁΩÆ:', targetIndex)
    
    // 3. Âà∑Êñ∞Êï∞ÊçÆ
    await loadMemos()
    showMessage('ÁßªÂä®ÊàêÂäü')
  } catch (error) {
    console.error('Drag drop error:', error)
    showMessage('ÊãñÊãΩÂ§±Ë¥•', 'error')
  }
}

// Ë±°ÈôêÂå∫ÂüüÊãñÊãΩÊîæÁΩÆ
const handleQuadrantDrop = async (targetQuadrant: string, event: DragEvent) => {
  event.preventDefault()
  console.log('Ë±°ÈôêÊîæÁΩÆ:', targetQuadrant)
  
  if (!draggedMemo.value) {
    return
  }
  
  const sourceQuadrant = draggedMemo.value.quadrant
  
  try {
    // Â¶ÇÊûúÊòØË∑®Ë±°ÈôêÊãñÊãΩÔºåÊõ¥Êñ∞Ë±°Èôê
    if (sourceQuadrant !== targetQuadrant) {
      await updateMemoQuadrant(draggedMemo.value.id!, targetQuadrant)
      await loadMemos()
      showMessage(`Â∑≤ÁßªÂä®Âà∞${getQuadrantName(targetQuadrant)}`)
    }
  } catch (error) {
    console.error('Quadrant drop error:', error)
    showMessage('ÁßªÂä®Â§±Ë¥•', 'error')
  }
}

// Ëé∑ÂèñË±°ÈôêÂêçÁß∞
const getQuadrantName = (quadrant: string) => {
  const names: Record<string, string> = {
    'urgent-important': 'ÈáçË¶Å‰∏îÁ¥ßÊÄ•',
    'important-not-urgent': 'ÈáçË¶Å‰∏çÁ¥ßÊÄ•',
    'urgent-not-important': 'Á¥ßÊÄ•‰∏çÈáçË¶Å',
    'not-urgent-not-important': '‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ•'
  }
  return names[quadrant] || quadrant
}

// ÊãñÊãΩÁ¶ªÂºÄË±°Èôê
const handleDragLeave = (event: DragEvent) => {
  // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÁ¶ªÂºÄ‰∫ÜË±°ÈôêÂå∫Âüü
  const rect = (event.currentTarget as HTMLElement).getBoundingClientRect()
  const x = event.clientX
  const y = event.clientY
  
  if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
    dragOverQuadrant.value = null
  }
}

// ÊãñÊãΩÁªìÊùü
const handleDragEnd = () => {
  draggedMemo.value = null
  dragOverQuadrant.value = null
  isDraggable.value = false
  currentPressedMemo.value = null
  
  // Ê∏ÖÈô§ÂÆöÊó∂Âô®
  if (pressTimer.value) {
    clearTimeout(pressTimer.value)
    pressTimer.value = null
  }
  
  // Ê∏ÖÈô§Ëá™Âä®ÊªöÂä®
  if (autoScrollInterval.value) {
    clearInterval(autoScrollInterval.value)
    autoScrollInterval.value = null
  }
}

// Êõ¥Êñ∞Â§áÂøòÂΩïÁöÑË±°Èôê
const updateMemoQuadrant = async (memoId: number, newQuadrant: string) => {
  if (typeof window !== 'undefined' && window.db) {
    const result = await window.db.updateMemo(memoId, { quadrant: newQuadrant })
    if (!result.success) {
      throw new Error(result.error)
    }
  } else {
    const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
    const index = savedMemos.findIndex((m: any) => m.id === memoId)
    if (index !== -1) {
      savedMemos[index].quadrant = newQuadrant
      localStorage.setItem('memos', JSON.stringify(savedMemos))
    }
  }
}

// Êõ¥Êñ∞Â§áÂøòÂΩïÊéíÂ∫è
const updateMemosOrder = async (quadrant: string, draggedMemoId: number, targetIndex: number) => {
  const quadrantMemos = getQuadrantMemos(quadrant)
  const newOrder: { id: number; sortOrder: number }[] = []
  
  // ÈáçÊñ∞ËÆ°ÁÆóÊéíÂ∫è
  let orderCounter = 0
  for (let i = 0; i < quadrantMemos.length; i++) {
    if (i === targetIndex) {
      // Âú®ÁõÆÊ†á‰ΩçÁΩÆÊèíÂÖ•ÊãñÊãΩÁöÑÂ§áÂøòÂΩï
      newOrder.push({ id: draggedMemoId, sortOrder: orderCounter++ })
    }
    
    if (quadrantMemos[i].id !== draggedMemoId) {
      newOrder.push({ id: quadrantMemos[i].id!, sortOrder: orderCounter++ })
    }
  }
  
  // Â¶ÇÊûúÁõÆÊ†á‰ΩçÁΩÆÂú®ÊúÄÂêéÔºå‰∏îËøòÊ≤°ÊúâÊ∑ªÂä†ÊãñÊãΩÁöÑÂ§áÂøòÂΩï
  if (!newOrder.find(item => item.id === draggedMemoId)) {
    newOrder.push({ id: draggedMemoId, sortOrder: orderCounter })
  }
  
  // ÊâπÈáèÊõ¥Êñ∞ÊéíÂ∫è
  for (const item of newOrder) {
    if (typeof window !== 'undefined' && window.db) {
      await window.db.updateMemo(item.id, { sortOrder: item.sortOrder })
    } else {
      const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
      const index = savedMemos.findIndex((m: any) => m.id === item.id)
      if (index !== -1) {
        savedMemos[index].sortOrder = item.sortOrder
        localStorage.setItem('memos', JSON.stringify(savedMemos))
      }
    }
  }
}

// Ëé∑ÂèñÁßªÂä®ÈÄâÈ°π
const getMoveOptions = (memo: Memo) => {
  const currentQuadrant = memo.quadrant
  const allQuadrants = [
    { key: 'urgent-important', label: 'ÈáçË¶Å‰∏îÁ¥ßÊÄ•' },
    { key: 'important-not-urgent', label: 'ÈáçË¶Å‰∏çÁ¥ßÊÄ•' },
    { key: 'urgent-not-important', label: 'Á¥ßÊÄ•‰∏çÈáçË¶Å' },
    { key: 'not-urgent-not-important', label: '‰∏çÈáçË¶Å‰∏çÁ¥ßÊÄ•' }
  ]
  
  return allQuadrants
    .filter(q => q.key !== currentQuadrant)
    .map(q => ({
      key: `${memo.id}-${q.key}`,
      label: `ÁßªÂä®Âà∞ ${q.label}`,
      quadrant: q.key,
      memoId: memo.id
    }))
}

// Â§ÑÁêÜÁßªÂä®Âà∞Ë±°Èôê
const handleMoveToQuadrant = async (key: string) => {
  const [memoId, targetQuadrant] = key.split('-').slice(0, 2)
  const fullTargetQuadrant = key.split('-').slice(1).join('-')
  
  try {
    await updateMemoQuadrant(Number(memoId), fullTargetQuadrant)
    await loadMemos()
    showMessage(`Â∑≤ÁßªÂä®Âà∞${getQuadrantName(fullTargetQuadrant)}`)
  } catch (error) {
    console.error('Move memo error:', error)
    showMessage('ÁßªÂä®Â§±Ë¥•', 'error')
  }
}

// ÂàáÊç¢Â§áÂøòÂΩïÂÆåÊàêÁä∂ÊÄÅ
const toggleMemoComplete = async (id: number, completed: boolean) => {
  try {
    const completedTime = completed ? Date.now() : undefined
    
    if (typeof window !== 'undefined' && window.db) {
      // Electron ÁéØÂ¢É
      const result = await window.db.updateMemo(id, { 
        completed, 
        completedTime 
      })
      if (result.success) {
        await loadMemos()
      } else {
        showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É
      const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
      const index = savedMemos.findIndex((m: any) => m.id === id)
      if (index !== -1) {
        savedMemos[index].completed = completed
        savedMemos[index].completedTime = completedTime
        localStorage.setItem('memos', JSON.stringify(savedMemos))
        await loadMemos()
      }
    }
  } catch (error) {
    console.error('Toggle complete error:', error)
    showMessage('Êìç‰ΩúÂ§±Ë¥•', 'error')
  }
}

// ÂØåÊñáÊú¨ÁºñËæëÂô®Â§ÑÁêÜ
const handleEditorInput = (event: Event) => {
  const target = event.target as HTMLElement
  
  // Ê£ÄÊü•ÂΩìÂâçÂÖâÊ†á‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çÂú®ÂõæÁâáÂÆπÂô®ÂÜÖ
  const selection = window.getSelection()
  if (selection && selection.rangeCount > 0) {
    const range = selection.getRangeAt(0)
    let currentNode = range.startContainer
    
    // Ê£ÄÊü•ÊòØÂê¶Âú®ÂõæÁâáÂÆπÂô®ÂÜÖ
    while (currentNode && currentNode !== target) {
      if (currentNode.nodeType === Node.ELEMENT_NODE) {
        const element = currentNode as Element
        if (element.classList?.contains('resizable-image-container')) {
          // Â¶ÇÊûúÂú®ÂõæÁâáÂÆπÂô®ÂÜÖÔºåÁßªÂä®Âà∞ÂÆπÂô®ÂêéÈù¢
          const parentNode = element.parentNode!
          const nextSibling = element.nextSibling
          
          let targetTextNode: Node
          if (nextSibling && nextSibling.nodeType === Node.TEXT_NODE) {
            targetTextNode = nextSibling
          } else {
            // ÂàõÂª∫Êñ∞ÁöÑÊñáÊú¨ËäÇÁÇπ
            targetTextNode = document.createTextNode('')
            parentNode.insertBefore(targetTextNode, nextSibling)
          }
          
          // ÁßªÂä®ÂÖâÊ†áÂà∞Ê≠£Á°Æ‰ΩçÁΩÆ
          const newRange = document.createRange()
          newRange.setStart(targetTextNode, 0)
          newRange.collapse(true)
          selection.removeAllRanges()
          selection.addRange(newRange)
          break
        }
      }
      currentNode = currentNode.parentNode
    }
  }
  
  // Â∞ÜÁºñËæëÂô®‰∏≠ÁöÑ base64 ÂõæÁâáÊõøÊç¢‰∏∫ÂéüÂßãË∑ØÂæÑÁî®‰∫é‰øùÂ≠ò
  let content = target.innerHTML
  
  // Êü•ÊâæÊâÄÊúâÂÖ∑Êúâ data-original-src Â±ûÊÄßÁöÑÂõæÁâá
  const images = target.querySelectorAll('img[data-original-src]')
  images.forEach((img: HTMLImageElement) => {
    const originalSrc = img.getAttribute('data-original-src')
    const currentSrc = img.getAttribute('src')
    if (originalSrc && currentSrc && originalSrc !== currentSrc) {
      // Âú®ÂÜÖÂÆπ‰∏≠ÊõøÊç¢‰∏∫ÂéüÂßãË∑ØÂæÑ
      content = content.replace(
        new RegExp(`src="${currentSrc.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"`, 'g'),
        `src="${originalSrc}"`
      )
      // ÂêåÊó∂ÁßªÈô§ data-original-src Â±ûÊÄß‰ª•ÈÅøÂÖçÂú®‰øùÂ≠òÁöÑ HTML ‰∏≠Âá∫Áé∞
      content = content.replace(/\s*data-original-src="[^"]*"/g, '')
    }
  })
  
  // Êõ¥Êñ∞ÂÜÖÂÆπ
  currentMemo.content = content
}

// Â§ÑÁêÜÁºñËæëÂô®Ëé∑ÂæóÁÑ¶ÁÇπ
const handleEditorFocus = () => {
  // Á°Æ‰øùÁºñËæëÂô®Ëé∑ÂæóÁÑ¶ÁÇπÊó∂ÔºåÂÜÖÂÆπÂêåÊ≠•
  if (editorRef.value) {
    currentMemo.content = editorRef.value.innerHTML
  }
}

// ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπÔºà‰øùÊåÅÂÖâÊ†á‰ΩçÁΩÆÔºâ
const setEditorContent = async (content: string) => {
  if (!editorRef.value) return
  
  // Â¶ÇÊûúÂÜÖÂÆπÁõ∏ÂêåÔºå‰∏çÊõ¥Êñ∞
  if (editorRef.value.innerHTML === content) return
  
  // Âú®ÊòæÁ§∫ÂâçÂ∞ÜÊú¨Âú∞Ë∑ØÂæÑËΩ¨Êç¢‰∏∫ base64
  const displayContent = await convertLocalPathToBase64(content)
  
  // ‰øùÂ≠òÂΩìÂâçÂÖâÊ†á‰ΩçÁΩÆ
  const selection = window.getSelection()
  const range = selection?.rangeCount ? selection.getRangeAt(0) : null
  const cursorOffset = range ? range.startOffset : 0
  const cursorContainer = range ? range.startContainer : null
  
  // Êõ¥Êñ∞ÂÜÖÂÆπ
  editorRef.value.innerHTML = displayContent
  
  // ÈáçÊñ∞ÁªëÂÆöÊâÄÊúâÂõæÁâá‰∫ã‰ª∂
  const imgContainers = editorRef.value.querySelectorAll('.resizable-image-container')
  imgContainers.forEach(container => {
    bindImageEvents(container as HTMLElement)
  })
  
  // ÊÅ¢Â§çÂÖâÊ†á‰ΩçÁΩÆ
  if (cursorContainer && range) {
    setTimeout(() => {
      try {
        const newSelection = window.getSelection()
        const newRange = document.createRange()
        
        // Â∞ùËØïÂú®Âéü‰ΩçÁΩÆÊÅ¢Â§çÂÖâÊ†á
        if (editorRef.value!.contains(cursorContainer)) {
          newRange.setStart(cursorContainer, Math.min(cursorOffset, cursorContainer.textContent?.length || 0))
        } else {
          // Â¶ÇÊûúÂéü‰ΩçÁΩÆ‰∏çÂ≠òÂú®ÔºåÊîæÂú®Êú´Â∞æ
          const lastChild = editorRef.value!.lastChild
          if (lastChild) {
            if (lastChild.nodeType === Node.TEXT_NODE) {
              newRange.setStart(lastChild, lastChild.textContent?.length || 0)
            } else {
              newRange.setStartAfter(lastChild)
            }
          } else {
            newRange.setStart(editorRef.value!, 0)
          }
        }
        
        newRange.collapse(true)
        newSelection?.removeAllRanges()
        newSelection?.addRange(newRange)
      } catch (error) {
        // Â¶ÇÊûúÊÅ¢Â§çÂ§±Ë¥•ÔºåÂ∞ÜÂÖâÊ†áÁßªÂà∞Êú´Â∞æ
        try {
          const newSelection = window.getSelection()
          const newRange = document.createRange()
          newRange.selectNodeContents(editorRef.value!)
          newRange.collapse(false) // ÂÄíÊï∞Á¨¨‰∫å‰∏™ÂèÇÊï∞‰∏∫falseË°®Á§∫Âú®Êú´Â∞æ
          newSelection?.removeAllRanges()
          newSelection?.addRange(newRange)
        } catch (fallbackError) {
          console.warn('Êó†Ê≥ïËÆæÁΩÆÂÖâÊ†á‰ΩçÁΩÆ:', fallbackError)
        }
      }
    }, 0)
  } else {
    // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÂÖâÊ†á‰ΩçÁΩÆÔºåÂ∞ÜÂÖâÊ†áÊîæÂú®Êú´Â∞æ
    setTimeout(() => {
      try {
        const selection = window.getSelection()
        const range = document.createRange()
        range.selectNodeContents(editorRef.value!)
        range.collapse(false)
        selection?.removeAllRanges()
        selection?.addRange(range)
      } catch (error) {
        console.warn('Êó†Ê≥ïËÆæÁΩÆÂàùÂßãÂÖâÊ†á‰ΩçÁΩÆ:', error)
      }
    }, 0)
  }
}

// Â§ÑÁêÜÁ≤òË¥¥‰∫ã‰ª∂
const handlePaste = async (event: ClipboardEvent) => {
  event.preventDefault()
  
  const items = event.clipboardData?.items
  if (!items) return
  
  let hasImage = false
  let textContent = ''
  
  // È¶ñÂÖàÊ£ÄÊü•ÊòØÂê¶ÊúâÂõæÁâá
  for (let i = 0; i < items.length; i++) {
    const item = items[i]
    
    if (item.type.indexOf('image') !== -1) {
      hasImage = true
      const file = item.getAsFile()
      if (file) {
        try {
          const imageUrl = await saveImageToLocal(file)
          await insertImageToEditor(imageUrl)
        } catch (error) {
          console.error('Save image error:', error)
          showMessage('ÂõæÁâá‰øùÂ≠òÂ§±Ë¥•', 'error')
        }
      }
    } else if (item.type === 'text/plain' && !hasImage) {
      // Âè™ÊúâÂú®Ê≤°ÊúâÂõæÁâáÊó∂ÊâçÂ§ÑÁêÜÊñáÊú¨
      textContent = await new Promise<string>((resolve) => {
        item.getAsString(resolve)
      })
    }
  }
  
  // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâá‰ΩÜÊúâÊñáÊú¨ÔºåÊèíÂÖ•ÊñáÊú¨
  if (!hasImage && textContent) {
    insertTextToEditor(textContent)
  }
}

// ‰øùÂ≠òÂõæÁâáÂà∞Êú¨Âú∞
const saveImageToLocal = async (file: File): Promise<string> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    reader.onload = async () => {
      const base64 = reader.result as string
      
      // Â¶ÇÊûúÂú® Electron ÁéØÂ¢É‰∏≠ÔºåÂ∞ùËØï‰ΩøÁî®Êñá‰ª∂Á≥ªÁªüÂ≠òÂÇ®
      if (typeof window !== 'undefined' && window.db && window.db.saveImage) {
        try {
          const result = await window.db.saveImage(base64, file.name)
          if (result.success) {
            console.log('ÂõæÁâá‰øùÂ≠òÊàêÂäüÔºåÊñá‰ª∂Ë∑ØÂæÑ:', result.path)
            // ËøîÂõûÊú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑÔºåËÄå‰∏çÊòØ base64
            const localPath = `app://local-file/${result.path}`
            resolve(localPath)
          } else {
            console.warn('Êñá‰ª∂Á≥ªÁªü‰øùÂ≠òÂ§±Ë¥•Ôºå‰ΩøÁî® base64:', result.error)
            resolve(base64)
          }
        } catch (error) {
          console.warn('Êñá‰ª∂Á≥ªÁªü‰øùÂ≠òÂ§±Ë¥•Ôºå‰ΩøÁî® base64:', error)
          resolve(base64)
        }
      } else {
        // Web ÁéØÂ¢ÉÊàñËÄÖÊóßÁâàÊú¨Ôºå‰ΩøÁî® base64
        resolve(base64)
      }
    }
    reader.onerror = reject
    reader.readAsDataURL(file)
  })
}

// Â∞ÜÁºñËæëÂô®ÂÜÖÂÆπ‰∏≠ÁöÑ base64 ÂõæÁâáËΩ¨Êç¢‰∏∫Êú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑÔºàÁî®‰∫é‰øùÂ≠òÔºâ
const convertBase64ToLocalPath = async (content: string): Promise<string> => {
  if (!content || typeof window === 'undefined' || !window.db) {
    return content
  }

  // ÂåπÈÖç base64 ÂõæÁâá
  const base64Regex = /<img[^>]+src="data:image\/[^;]+;base64,([^"]+)"[^>]*>/g
  let convertedContent = content
  let match
  
  while ((match = base64Regex.exec(content)) !== null) {
    const fullMatch = match[0]
    const base64Data = `data:image/jpeg;base64,${match[1]}`
    
    try {
      // ‰øùÂ≠òÂõæÁâáÂà∞Êú¨Âú∞Êñá‰ª∂Á≥ªÁªü
      const timestamp = Date.now()
      const fileName = `converted_${timestamp}.jpg`
      const result = await window.db.saveImage(base64Data, fileName)
      
      if (result.success) {
        const localPath = `app://local-file/${result.path}`
        const newImgTag = fullMatch.replace(/src="data:image\/[^;]+;base64,[^"]+"/, `src="${localPath}"`)
        convertedContent = convertedContent.replace(fullMatch, newImgTag)
        console.log('ËΩ¨Êç¢ÂõæÁâáË∑ØÂæÑ:', fileName, '->', localPath)
      }
    } catch (error) {
      console.warn('ËΩ¨Êç¢ÂõæÁâáÂ§±Ë¥•:', error)
    }
  }
  
  return convertedContent
}

// Â∞ÜÊú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑËΩ¨Êç¢‰∏∫ base64ÔºàÁî®‰∫éÊòæÁ§∫Ôºâ
const convertLocalPathToBase64 = async (content: string): Promise<string> => {
  if (!content || typeof window === 'undefined' || !window.db) {
    return content
  }

  // ÂåπÈÖçÊú¨Âú∞Êñá‰ª∂Ë∑ØÂæÑ
  const localPathRegex = /<img[^>]+src="app:\/\/local-file\/([^"]+)"[^>]*>/g
  let convertedContent = content
  let match
  
  while ((match = localPathRegex.exec(content)) !== null) {
    const fullMatch = match[0]
    const relativePath = match[1]
    
    try {
      // Ëé∑ÂèñÂõæÁâáÁöÑ base64 Êï∞ÊçÆÔºàÈÄöËøá IPC ÈÄö‰ø°Ôºâ
      const result = await window.db.getImageBase64?.(relativePath)
      
      if (result?.success && result.base64) {
        const newImgTag = fullMatch.replace(/src="app:\/\/local-file\/[^"]+"/, `src="${result.base64}"`)
        convertedContent = convertedContent.replace(fullMatch, newImgTag)
        console.log('ÊÅ¢Â§çÂõæÁâáÊòæÁ§∫:', relativePath)
      } else {
        console.warn('Ëé∑ÂèñÂõæÁâá base64 Â§±Ë¥•:', relativePath, result?.error)
      }
    } catch (error) {
      console.warn('Ëé∑ÂèñÂõæÁâáË∑ØÂæÑÂ§±Ë¥•:', error)
    }
  }
  
  return convertedContent
}

// ÁªëÂÆöÂõæÁâá‰∫ã‰ª∂ÁöÑÂáΩÊï∞
const bindImageEvents = (imgContainer: HTMLElement) => {
  const img = imgContainer.querySelector('img') as HTMLImageElement
  const resizeHandle = imgContainer.querySelector('.resize-handle') as HTMLElement
  
  if (!img || !resizeHandle) return
  
  // ÁªëÂÆöÂõæÁâáÁÇπÂáª‰∫ã‰ª∂
  img.onclick = (e) => {
    e.preventDefault()
    e.stopPropagation()
    window.getSelection()?.removeAllRanges()
    selectImage(imgContainer)
  }
  
  // ÁªëÂÆöÊãñÊãΩ‰∫ã‰ª∂
  let isResizing = false
  let startX = 0, startY = 0, startWidth = 0, startHeight = 0
  
  resizeHandle.onmousedown = (e) => {
    e.preventDefault()
    e.stopPropagation()
    window.getSelection()?.removeAllRanges()
    
    isResizing = true
    startX = e.clientX
    startY = e.clientY
    startWidth = img.offsetWidth
    startHeight = img.offsetHeight
    
    const handleResize = (e: MouseEvent) => {
      if (!isResizing) return
      
      const deltaX = e.clientX - startX
      const deltaY = e.clientY - startY
      
      if (e.shiftKey) {
        const aspectRatio = startWidth / startHeight
        const newWidth = Math.max(50, startWidth + deltaX)
        const newHeight = newWidth / aspectRatio
        
        img.style.width = newWidth + 'px'
        img.style.height = newHeight + 'px'
      } else {
        img.style.width = Math.max(50, startWidth + deltaX) + 'px'
        img.style.height = Math.max(30, startHeight + deltaY) + 'px'
      }
      
      currentMemo.content = editorRef.value!.innerHTML
    }
    
    const stopResize = () => {
      isResizing = false
      document.removeEventListener('mousemove', handleResize)
      document.removeEventListener('mouseup', stopResize)
    }
    
    document.addEventListener('mousemove', handleResize)
    document.addEventListener('mouseup', stopResize)
  }
}

// ÊèíÂÖ•ÂõæÁâáÂà∞ÁºñËæëÂô®
const insertImageToEditor = async (imageUrl: string) => {
  if (!editorRef.value) return
  
  // Â¶ÇÊûúÊòØÊú¨Âú∞Ë∑ØÂæÑÔºåËΩ¨Êç¢‰∏∫ base64 Áî®‰∫éÊòæÁ§∫
  let displayUrl = imageUrl
  if (imageUrl.startsWith('app://local-file/') && typeof window !== 'undefined' && window.db?.getImageBase64) {
    try {
      const relativePath = imageUrl.replace('app://local-file/', '')
      const result = await window.db.getImageBase64(relativePath)
      if (result.success && result.base64) {
        displayUrl = result.base64
        console.log('ËΩ¨Êç¢Êú¨Âú∞Ë∑ØÂæÑ‰∏∫ base64 ÊòæÁ§∫:', relativePath)
      }
    } catch (error) {
      console.warn('Êó†Ê≥ïËé∑ÂèñÂõæÁâá base64Ôºå‰ΩøÁî®ÂéüË∑ØÂæÑ:', error)
    }
  }
  
  // ÂàõÂª∫‰∏Ä‰∏™ÂåÖË£ÖÂÆπÂô®divÔºåËÄå‰∏çÊòØspan
  const wrapperDiv = document.createElement('div')
  wrapperDiv.style.cssText = `
    display: inline-block;
    margin: 0;
    vertical-align: top;
  `
  
  // ÂàõÂª∫ÂõæÁâáÂÆπÂô®
  const imgContainer = document.createElement('span')
  imgContainer.className = 'resizable-image-container'
  imgContainer.style.cssText = `
    position: relative;
    display: inline-block;
    margin: 0 4px;
    border: 2px solid transparent;
    border-radius: 4px;
    vertical-align: top;
    max-width: fit-content;
  `
  
  const img = document.createElement('img')
  img.src = displayUrl  // ‰ΩøÁî®ËΩ¨Êç¢ÂêéÁöÑ base64 ÊòæÁ§∫
  // ‰øùÂ≠òÂéüÂßãË∑ØÂæÑ‰ø°ÊÅØ‰Ωú‰∏∫Êï∞ÊçÆÂ±ûÊÄßÁî®‰∫é‰øùÂ≠ò
  img.setAttribute('data-original-src', imageUrl)
  img.style.cssText = `
    max-width: 200px;
    max-height: 150px;
    height: auto;
    display: inline-block;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    vertical-align: top;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  `
  
  // ÂàõÂª∫Ë∞ÉÊï¥ÊâãÊüÑ
  const resizeHandle = document.createElement('div')
  resizeHandle.className = 'resize-handle'
  resizeHandle.style.cssText = `
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 10px;
    height: 10px;
    background: #40a9ff;
    border: 2px solid white;
    border-radius: 50%;
    cursor: nw-resize;
    display: none;
    z-index: 10;
  `
  
  imgContainer.appendChild(img)
  imgContainer.appendChild(resizeHandle)
  wrapperDiv.appendChild(imgContainer)
  
  // ‰ΩøÁî®document.execCommandÊèíÂÖ•HTMLÔºåËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùÊ≠£Á°ÆÁöÑÂÖâÊ†á‰ΩçÁΩÆ
  const selection = window.getSelection()
  if (selection && selection.rangeCount > 0) {
    const range = selection.getRangeAt(0)
    range.deleteContents()
    
    // ‰ΩøÁî®insertHTMLÊõø‰ª£Áõ¥Êé•ÊèíÂÖ•DOMËäÇÁÇπ
    try {
      document.execCommand('insertHTML', false, wrapperDiv.outerHTML + '&nbsp;')
      
      // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®Âà∞Êñ∞ÊèíÂÖ•ÁöÑÂõæÁâá
      setTimeout(() => {
        const newImgContainers = editorRef.value!.querySelectorAll('.resizable-image-container')
        const lastContainer = newImgContainers[newImgContainers.length - 1] as HTMLElement
        if (lastContainer) {
          bindImageEvents(lastContainer)
        }
      }, 0)
    } catch (error) {
      // Â¶ÇÊûúexecCommand‰∏çÊîØÊåÅÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à
      range.insertNode(wrapperDiv)
      bindImageEvents(imgContainer)
      
      // Âú®ÂõæÁâáÂêéÈù¢Ê∑ªÂä†‰∏Ä‰∏™ÈùûÊñ≠Á©∫Ê†ºÂíåÊç¢Ë°å
      const spacer = document.createTextNode('\u00A0')
      const br = document.createElement('br')
      
      range.setStartAfter(wrapperDiv)
      range.insertNode(spacer)
      range.setStartAfter(spacer)
      range.insertNode(br)
      
      range.setStartAfter(br)
      range.collapse(true)
      selection.removeAllRanges()
      selection.addRange(range)
    }
  } else {
    editorRef.value.innerHTML += wrapperDiv.outerHTML + '&nbsp;<br>'
    
    // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
    setTimeout(() => {
      const newImgContainers = editorRef.value!.querySelectorAll('.resizable-image-container')
      const lastContainer = newImgContainers[newImgContainers.length - 1] as HTMLElement
      if (lastContainer) {
        bindImageEvents(lastContainer)
      }
    }, 0)
  }
  
  // Êõ¥Êñ∞ÂÜÖÂÆπ
  currentMemo.content = editorRef.value.innerHTML
}

// ÈÄâ‰∏≠ÂõæÁâá
const selectImage = (container: HTMLElement) => {
  // Ê∏ÖÈô§ÊñáÊú¨ÈÄâ‰∏≠
  window.getSelection()?.removeAllRanges()
  
  // Ê∏ÖÈô§ÂÖ∂‰ªñÈÄâ‰∏≠Áä∂ÊÄÅ
  document.querySelectorAll('.resizable-image-container').forEach(el => {
    el.style.border = '2px solid transparent'
    const handle = el.querySelector('.resize-handle') as HTMLElement
    if (handle) handle.style.display = 'none'
  })
  
  // ËÆæÁΩÆÂΩìÂâçÈÄâ‰∏≠Áä∂ÊÄÅÔºåÂè™Âú®ÂõæÁâáÂÆπÂô®‰∏äÊòæÁ§∫ËæπÊ°Ü
  container.style.border = '2px solid #40a9ff'
  const handle = container.querySelector('.resize-handle') as HTMLElement
  if (handle) handle.style.display = 'block'
  
  // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂèñÊ∂àÈÄâ‰∏≠
  const clearSelection = (e: Event) => {
    const target = e.target as Node
    if (!container.contains(target) && target !== container) {
      container.style.border = '2px solid transparent'
      if (handle) handle.style.display = 'none'
      document.removeEventListener('click', clearSelection)
    }
  }
  
  setTimeout(() => {
    document.addEventListener('click', clearSelection)
  }, 100)
}

// ÊèíÂÖ•ÊñáÊú¨Âà∞ÁºñËæëÂô®
const insertTextToEditor = (text: string) => {
  if (!editorRef.value || !text) return
  
  const selection = window.getSelection()
  if (selection && selection.rangeCount > 0) {
    const range = selection.getRangeAt(0)
    
    // Á°Æ‰øùÊàë‰ª¨Âú®Ê≠£Á°ÆÁöÑ‰ΩçÁΩÆÊèíÂÖ•ÊñáÊú¨
    let targetNode = range.startContainer
    let targetOffset = range.startOffset
    
    // Â¶ÇÊûúÂÖâÊ†áÂú®ÂõæÁâáÂÆπÂô®ÂÜÖÔºåÁßªÂä®Âà∞ÂÆπÂô®Â§ñ
    while (targetNode && targetNode.nodeType === Node.ELEMENT_NODE) {
      const element = targetNode as Element
      if (element.classList?.contains('resizable-image-container')) {
        // Â¶ÇÊûúÂú®ÂõæÁâáÂÆπÂô®ÂÜÖÔºåÁßªÂä®Âà∞ÂÆπÂô®ÂêéÈù¢
        const parentNode = element.parentNode!
        const nextSibling = element.nextSibling
        
        if (nextSibling && nextSibling.nodeType === Node.TEXT_NODE) {
          range.setStart(nextSibling, 0)
        } else {
          // ÂàõÂª∫Êñ∞ÁöÑÊñáÊú¨ËäÇÁÇπ
          const newTextNode = document.createTextNode('')
          parentNode.insertBefore(newTextNode, nextSibling)
          range.setStart(newTextNode, 0)
        }
        break
      }
      
      // Ê£ÄÊü•Áà∂Á∫ß
      if (targetOffset < element.childNodes.length) {
        targetNode = element.childNodes[targetOffset]
        targetOffset = 0
      } else {
        break
      }
    }
    
    // ‰ΩøÁî®document.execCommandÊèíÂÖ•ÊñáÊú¨ÔºåËøôÊ†∑ÂèØ‰ª•‰øùÊåÅÊ≠£Á°ÆÁöÑÂÖâÊ†á‰ΩçÁΩÆ
    try {
      // Â∞ÜÊñáÊú¨ËΩ¨‰πâHTMLÂ≠óÁ¨¶‰ª•ÈÅøÂÖçÈóÆÈ¢ò
      const escapedText = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>')
      
      document.execCommand('insertHTML', false, escapedText)
    } catch (error) {
      // Â¶ÇÊûúexecCommandÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à
      range.deleteContents()
      
      // ÂàõÂª∫ÊñáÊú¨ËäÇÁÇπ
      const lines = text.split('\n')
      for (let i = 0; i < lines.length; i++) {
        if (i > 0) {
          range.insertNode(document.createElement('br'))
        }
        if (lines[i]) {
          const textNode = document.createTextNode(lines[i])
          range.insertNode(textNode)
          range.setStartAfter(textNode)
        }
      }
      
      range.collapse(true)
      selection.removeAllRanges()
      selection.addRange(range)
    }
  } else {
    // Â¶ÇÊûüÊ≤°ÊúâÈÄâ‰∏≠Âå∫ÂüüÔºåÁõ¥Êé•Ê∑ªÂä†Âà∞Êú´Â∞æ
    const escapedText = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/\n/g, '<br>')
    
    editorRef.value.innerHTML += escapedText
  }
  
  // Êõ¥Êñ∞ÂÜÖÂÆπ
  currentMemo.content = editorRef.value.innerHTML
}

// ÊâìÂºÄÊñ∞Â¢ûÊ®°ÊÄÅÊ°Ü
const openAddModal = (quadrant: string) => {
  isEditing.value = false
  currentMemo.id = undefined
  currentMemo.title = ''
  currentMemo.content = ''
  currentMemo.quadrant = quadrant
  currentMemo.completed = false
  showModal.value = true
  
  // Ê∏ÖÁ©∫ÁºñËæëÂô®Ôºå‰ΩÜ‰∏çËá™Âä®ËÅöÁÑ¶
  setTimeout(() => {
    if (editorRef.value) {
      editorRef.value.innerHTML = ''
    }
  }, 100)
}

// ÊâìÂºÄÁºñËæëÊ®°ÊÄÅÊ°Ü
const openEditModal = async (memo: Memo) => {
  isEditing.value = true
  currentMemo.id = memo.id
  currentMemo.title = memo.title
  currentMemo.content = memo.content
  currentMemo.quadrant = memo.quadrant
  currentMemo.completed = memo.completed || false
  showModal.value = true
  
  // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπÔºå‰ΩÜ‰∏çËá™Âä®ËÅöÁÑ¶
  setTimeout(async () => {
    if (editorRef.value) {
      await setEditorContent(memo.content || '')
    }
  }, 100)
}

// ‰ΩøÁî®ÂÖ®Â±ÄÈÄöÁü•ÊñπÊ≥ï
const showMessage = (message: string, type: 'success' | 'error' = 'success') => {
  // ‰ΩøÁî®ÂéüÁîü DOM ÊòæÁ§∫ÈÄöÁü•ÔºåÈÅøÂÖç useMessage ÈóÆÈ¢ò
  const notification = document.createElement('div')
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background: ${type === 'success' ? '#52c41a' : '#ff4d4f'};
    color: white;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    font-size: 14px;
  `
  notification.textContent = message
  document.body.appendChild(notification)
  
  setTimeout(() => {
    document.body.removeChild(notification)
  }, 3000)
}

// ‰øùÂ≠òÂ§áÂøòÂΩï
const saveMemo = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      // Electron ÁéØÂ¢É
      if (isEditing.value && currentMemo.id) {
        const result = await window.db.updateMemo(currentMemo.id, {
          title: currentMemo.title,
          content: currentMemo.content,
          quadrant: currentMemo.quadrant
        })
        
        if (result.success) {
          showMessage('Êõ¥Êñ∞ÊàêÂäü')
          await loadMemos()
        } else {
          showMessage('Êõ¥Êñ∞Â§±Ë¥•: ' + result.error, 'error')
        }
      } else {
        const result = await window.db.addMemo({
          title: currentMemo.title,
          content: currentMemo.content,
          quadrant: currentMemo.quadrant
        })
        
        if (result.success) {
          showMessage('‰øùÂ≠òÊàêÂäü')
          await loadMemos()
        } else {
          showMessage('‰øùÂ≠òÂ§±Ë¥•: ' + result.error, 'error')
        }
      }
    } else {
      // Web ÁéØÂ¢É‰ΩøÁî® localStorage
      const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
      
      if (isEditing.value && currentMemo.id) {
        // Êõ¥Êñ∞
        const index = savedMemos.findIndex((m: any) => m.id === currentMemo.id)
        if (index !== -1) {
          savedMemos[index] = { ...currentMemo }
          localStorage.setItem('memos', JSON.stringify(savedMemos))
          showMessage('Êõ¥Êñ∞ÊàêÂäü')
          await loadMemos()
        }
      } else {
        // Êñ∞Â¢û
        const newMemo = {
          ...currentMemo,
          id: Date.now(),
          created: Date.now()
        }
        savedMemos.push(newMemo)
        localStorage.setItem('memos', JSON.stringify(savedMemos))
        showMessage('‰øùÂ≠òÊàêÂäü')
        await loadMemos()
      }
    }
    
    showModal.value = false
  } catch (error) {
    console.error('Save memo error:', error)
    showMessage('Êìç‰ΩúÂ§±Ë¥•', 'error')
  }
}

// Âà†Èô§Â§áÂøòÂΩï
const deleteMemo = async (id: number) => {
  if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Â§áÂøòÂΩïÂêóÔºü')) {
    try {
      if (typeof window !== 'undefined' && window.db) {
        // Electron ÁéØÂ¢É
        const result = await window.db.deleteMemo(id)
        if (result.success) {
          showMessage('Âà†Èô§ÊàêÂäü')
          await loadMemos()
          
          // Âú®Âà†Èô§ÂêéËá™Âä®Ê∏ÖÁêÜÊó†Áî®ÂõæÁâá
          setTimeout(async () => {
            try {
              await window.db.cleanupUnusedImages()
            } catch (error) {
              console.warn('Auto cleanup failed:', error)
            }
          }, 1000)
        } else {
          showMessage('Âà†Èô§Â§±Ë¥•: ' + result.error, 'error')
        }
      } else {
        // Web ÁéØÂ¢É
        const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
        const filteredMemos = savedMemos.filter((memo: any) => memo.id !== id)
        localStorage.setItem('memos', JSON.stringify(filteredMemos))
        showMessage('Âà†Èô§ÊàêÂäü')
        await loadMemos()
      }
    } catch (error) {
      console.error('Delete memo error:', error)
      showMessage('Âà†Èô§Â§±Ë¥•', 'error')
    }
  }
}

// Âä†ËΩΩÂ§áÂøòÂΩïÊï∞ÊçÆ
const loadMemos = async () => {
  try {
    // Ê£ÄÊü•ÊòØÂê¶Âú® Electron ÁéØÂ¢É‰∏≠
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.getMemos()
      if (result.success) {
        memos.value = result.data
        
        // Âú®È¶ñÊ¨°Âä†ËΩΩÂêéÊâßË°å‰∏ÄÊ¨° base64 ÂõæÁâáËøÅÁßª
        try {
          const migrationResult = await window.db.migrateBase64Images?.()
          if (migrationResult?.success && migrationResult.migrated > 0) {
            console.log(`Ëá™Âä®ËøÅÁßª‰∫Ü ${migrationResult.migrated} Âº† base64 ÂõæÁâáÂà∞Êú¨Âú∞Êñá‰ª∂`)
            // ËøÅÁßªÂêéÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
            const reloadResult = await window.db.getMemos()
            if (reloadResult.success) {
              memos.value = reloadResult.data
            }
          }
        } catch (migrationError) {
          console.warn('ÂõæÁâáËøÅÁßªÂ§±Ë¥•:', migrationError)
        }
      } else {
        showMessage('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É‰ΩøÁî® localStorage
      const savedMemos = localStorage.getItem('memos')
      if (savedMemos) {
        memos.value = JSON.parse(savedMemos)
      }
    }
  } catch (error) {
    console.error('Load memos error:', error)
    showMessage('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•', 'error')
  }
}

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
onMounted(async () => {
  // Âä†ËΩΩ‰∏ªÈ¢òËÆæÁΩÆ
  const savedTheme = localStorage.getItem('theme')
  isDark.value = savedTheme === 'dark'
  
  // ÂàùÂßãÂåñÁâàÊú¨‰ø°ÊÅØ
  initVersionInfo()
  
  // Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï
  await loadCurrentDataPath()
  
  // Âä†ËΩΩÊï∞ÊçÆ
  await loadMemos()
})

// ÂéãÁº©ÂåÖÂØºÂá∫ÂäüËÉΩ
const exportPackage = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      // Ëé∑Âèñ‰∏ªÈ¢òËÆæÁΩÆÂπ∂‰º†ÈÄíÁªôÂØºÂá∫ÂáΩÊï∞
      const theme = localStorage.getItem('theme') || 'light'
      
      console.log('ÂºÄÂßãÂØºÂá∫ÂéãÁº©ÂåÖ...')
      const result = await window.db.exportPackage(theme)
      
      if (result.success) {
        console.log('ÂØºÂá∫ÊàêÂäüÔºåÊï∞ÊçÆÂ§ßÂ∞è:', result.data?.byteLength, 'bytes')
        
        // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
        const blob = new Blob([result.data], { type: 'application/zip' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = `ÂõõË±°ÈôêTODO_ÂÆåÊï¥Â§á‰ªΩ_${new Date().toISOString().split('T')[0]}.zip`
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
        
        showMessage('ÂéãÁº©ÂåÖÂØºÂá∫ÊàêÂäüÔºÅÂåÖÂê´ÊâÄÊúâÊï∞ÊçÆÂíåÂõæÁâá')
      } else {
        console.error('ÂØºÂá∫Â§±Ë¥•:', result.error)
        showMessage('ÂØºÂá∫Â§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É‰∏çÊîØÊåÅÂéãÁº©ÂåÖÂØºÂá∫
      showMessage('Web ÁéØÂ¢É‰∏çÊîØÊåÅÂéãÁº©ÂåÖÂØºÂá∫', 'warning')
    }
  } catch (error) {
    console.error('Export package error:', error)
    showMessage('ÂØºÂá∫Â§±Ë¥•', 'error')
  }
}

// ÂéãÁº©ÂåÖ‰∏ä‰º†Â§ÑÁêÜ
const handlePackageUpload = async (data: { file: { file?: File } }) => {
  const file = data.file.file
  if (!file) return false
  
  try {
    const arrayBuffer = await file.arrayBuffer()
    const buffer = new Uint8Array(arrayBuffer)
    await importPackage(buffer)
  } catch (error) {
    console.error('Package upload error:', error)
    showMessage('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', 'error')
  }
  
  return false // ÈòªÊ≠¢ÈªòËÆ§‰∏ä‰º†Ë°å‰∏∫
}

// ÂéãÁº©ÂåÖÂØºÂÖ•ÂäüËÉΩ
const importPackage = async (zipData: Uint8Array) => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.importPackage(zipData)
      if (result.success) {
        showMessage(`ÂéãÁº©ÂåÖÂØºÂÖ•ÊàêÂäüÔºÅÂÖ±ÂØºÂÖ• ${result.imported} Êù°ËÆ∞ÂΩï`)
        
        // Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
        if (result.theme) {
          localStorage.setItem('theme', result.theme)
        }
        
        await loadMemos()
        showDataManageModal.value = false
        
        // ÂØºÂÖ•ÂêéËá™Âä®Ê∏ÖÁêÜÊó†Áî®ÂõæÁâáÔºàÂª∂ËøüÊâßË°å‰ª•Á°Æ‰øùÊï∞ÊçÆÂ∑≤Âä†ËΩΩÔºâ
        setTimeout(async () => {
          try {
            const cleanupResult = await window.db.cleanupUnusedImages()
            if (cleanupResult.success && cleanupResult.cleaned && cleanupResult.cleaned > 0) {
              showMessage(`Ê∏ÖÁêÜ‰∫Ü ${cleanupResult.cleaned} ‰∏™Êó†Áî®ÂõæÁâáÊñá‰ª∂`)
            }
          } catch (error) {
            console.warn('Auto cleanup after import failed:', error)
          }
        }, 2000)
        
        // Âà∑Êñ∞È°µÈù¢‰ª•Â∫îÁî®‰∏ªÈ¢òËÆæÁΩÆ
        setTimeout(() => {
          location.reload()
        }, 3000)
      } else {
        showMessage('ÂØºÂÖ•Â§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É‰∏çÊîØÊåÅÂéãÁº©ÂåÖÂØºÂÖ•
      showMessage('Web ÁéØÂ¢É‰∏çÊîØÊåÅÂéãÁº©ÂåÖÂØºÂÖ•ÔºåËØ∑‰ΩøÁî® JSON ÂØºÂÖ•', 'warning')
    }
  } catch (error) {
    console.error('Import package error:', error)
    showMessage('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºèÈîôËØØ', 'error')
  }
}

// Á°ÆËÆ§Ê∏ÖÁ©∫Êï∞ÊçÆ
const confirmClearData = () => {
  if (confirm('Ë≠¶ÂëäÔºÅÊ≠§Êìç‰ΩúÂ∞ÜÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÔºå‰∏î‰∏çÂèØÊÅ¢Â§èÔºÅ\n\nËØ∑Âú®Êìç‰ΩúÂâçÂÖàÂØºÂá∫Êï∞ÊçÆËøõË°åÂ§á‰ªΩ„ÄÇ\n\nÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
    clearAllData()
  }
}

// Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ
const clearAllData = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.clearAllData()
      if (result.success) {
        showMessage('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫')
        await loadMemos()
        showDataManageModal.value = false
        
        // ÈáçÁΩÆ‰∏ªÈ¢ò
        isDark.value = false
      } else {
        showMessage('Ê∏ÖÁ©∫Â§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É
      localStorage.removeItem('memos')
      localStorage.removeItem('theme')
      
      showMessage('ÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫')
      await loadMemos()
      showDataManageModal.value = false
      
      // ÈáçÁΩÆ‰∏ªÈ¢ò
      isDark.value = false
    }
  } catch (error) {
    console.error('Clear data error:', error)
    showMessage('Ê∏ÖÁ©∫Â§±Ë¥•', 'error')
  }
}

// Ê∏ÖÁêÜÊó†Áî®ÂõæÁâá
const cleanupUnusedImages = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.cleanupUnusedImages()
      if (result.success) {
        if (result.cleaned && result.cleaned > 0) {
          showMessage(result.message || `Ê∏ÖÁêÜÂÆåÊàêÔºåÂà†Èô§‰∫Ü ${result.cleaned} ‰∏™Êó†Áî®ÂõæÁâá`)
        } else {
          showMessage('Ê≤°ÊúâÂèëÁé∞Êó†Áî®ÂõæÁâá')
        }
      } else {
        showMessage('Ê∏ÖÁêÜÂ§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      // Web ÁéØÂ¢É‰∏çÊîØÊåÅÂõæÁâáÊ∏ÖÁêÜ
      showMessage('Web ÁéØÂ¢É‰∏çÊîØÊåÅÂõæÁâáÊ∏ÖÁêÜÂäüËÉΩ', 'warning')
    }
  } catch (error) {
    console.error('Cleanup images error:', error)
    showMessage('Ê∏ÖÁêÜÂ§±Ë¥•', 'error')
  }
}

// Ëé∑ÂèñÂ∑≤ÂÆåÊàêÁöÑÂæÖÂäûÔºàÊåâÂÆåÊàêÊó∂Èó¥ÂÄíÂ∫èÔºâ
const getCompletedMemos = () => {
  return memos.value
    .filter(memo => memo.completed && memo.completedTime)
    .sort((a, b) => (b.completedTime || 0) - (a.completedTime || 0))
}

// Ê†ºÂºèÂåñÂÆåÊàêÊó∂Èó¥
const formatCompletedTime = (timestamp?: number) => {
  if (!timestamp) return ''
  
  const date = new Date(timestamp)
  const now = new Date()
  const diffTime = now.getTime() - timestamp
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
  const diffHours = Math.floor(diffTime / (1000 * 60 * 60))
  const diffMinutes = Math.floor(diffTime / (1000 * 60))
  
  if (diffMinutes < 60) {
    return `${diffMinutes}ÂàÜÈíüÂâç`
  } else if (diffHours < 24) {
    return `${diffHours}Â∞èÊó∂Ââç`
  } else if (diffDays === 1) {
    return 'Êò®Â§©'
  } else if (diffDays < 7) {
    return `${diffDays}Â§©Ââç`
  } else {
    // ÊòæÁ§∫ÊúàÊó•Ê†ºÂºè
    const month = date.getMonth() + 1
    const day = date.getDate()
    return `${month}Êúà${day}Êó•`
  }
}

// ÊÅ¢Â§ç‰ªªÂä°‰∏∫Êú™ÂÆåÊàêÁä∂ÊÄÅ
const uncompleteTask = async (id: number) => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.updateMemo(id, { 
        completed: false, 
        completedTime: undefined 
      })
      if (result.success) {
        await loadMemos()
        showMessage('‰ªªÂä°Â∑≤ÊÅ¢Â§ç')
      } else {
        showMessage('ÊÅ¢Â§çÂ§±Ë¥•: ' + result.error, 'error')
      }
    } else {
      const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
      const index = savedMemos.findIndex((m: any) => m.id === id)
      if (index !== -1) {
        savedMemos[index].completed = false
        delete savedMemos[index].completedTime
        localStorage.setItem('memos', JSON.stringify(savedMemos))
        await loadMemos()
        showMessage('‰ªªÂä°Â∑≤ÊÅ¢Â§ç')
      }
    }
  } catch (error) {
    console.error('Uncomplete task error:', error)
    showMessage('ÊÅ¢Â§çÂ§±Ë¥•', 'error')
  }
}

// Âà†Èô§Â∑≤ÂÆåÊàêÁöÑÂæÖÂäû
const deleteCompletedMemo = async (id: number) => {
  if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Â∑≤ÂÆåÊàêÁöÑÂ§áÂøòÂΩïÂêóÔºü')) {
    await deleteMemo(id)
  }
}

// Ê∏ÖÁ©∫ÊâÄÊúâÂ∑≤ÂÆåÊàêÁöÑÂæÖÂäû
const clearCompletedMemos = async () => {
  if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂ∑≤ÂÆåÊàêÁöÑÂæÖÂäûÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
    const completedIds = getCompletedMemos().map(memo => memo.id!)
    
    try {
      for (const id of completedIds) {
        if (typeof window !== 'undefined' && window.db) {
          await window.db.deleteMemo(id)
        } else {
          const savedMemos = JSON.parse(localStorage.getItem('memos') || '[]')
          const filteredMemos = savedMemos.filter((memo: any) => memo.id !== id)
          localStorage.setItem('memos', JSON.stringify(filteredMemos))
        }
      }
      
      await loadMemos()
      showMessage(`Â∑≤Ê∏ÖÁ©∫ ${completedIds.length} Êù°Â∑≤ÂÆåÊàêÂæÖÂäû`)
      showCompletedModal.value = false
      
      // Âú®Ê∏ÖÁ©∫ÂêéËá™Âä®Ê∏ÖÁêÜÊó†Áî®ÂõæÁâá
      if (typeof window !== 'undefined' && window.db) {
        setTimeout(async () => {
          try {
            await window.db.cleanupUnusedImages()
          } catch (error) {
            console.warn('Auto cleanup failed:', error)
          }
        }, 1000)
      }
    } catch (error) {
      console.error('Clear completed memos error:', error)
      showMessage('Ê∏ÖÁ©∫Â§±Ë¥•', 'error')
    }
  }
}

// Êü•ÁúãÂ∑≤ÂÆåÊàêÂæÖÂäûËØ¶ÊÉÖ
const viewCompletedMemoDetail = (memo: Memo) => {
  selectedCompletedMemo.value = memo
  showCompletedDetailModal.value = true
}

// ‰ªéËØ¶ÊÉÖÈ°µÊÅ¢Â§ç‰ªªÂä°
const uncompleteTaskFromDetail = async () => {
  if (selectedCompletedMemo.value) {
    await uncompleteTask(selectedCompletedMemo.value.id!)
    showCompletedDetailModal.value = false
    selectedCompletedMemo.value = null
  }
}

// Ê†ºÂºèÂåñÂàõÂª∫Êó∂Èó¥
const formatCreatedTime = (timestamp?: number) => {
  if (!timestamp) return ''
  
  const date = new Date(timestamp)
  const year = date.getFullYear()
  const month = date.getMonth() + 1
  const day = date.getDate()
  const hours = date.getHours().toString().padStart(2, '0')
  const minutes = date.getMinutes().toString().padStart(2, '0')
  
  return `${year}Âπ¥${month}Êúà${day}Êó• ${hours}:${minutes}`
}

// ÂàùÂßãÂåñÁâàÊú¨‰ø°ÊÅØ
const initVersionInfo = () => {
  // ËøôÈáåÂèØ‰ª•‰ªéÊûÑÂª∫Êó∂Ê≥®ÂÖ•ÁöÑÁéØÂ¢ÉÂèòÈáèËé∑ÂèñÔºåÊàñËÄÖ‰ΩøÁî®ÈªòËÆ§ÂÄº
  appVersion.value = '1.0.0'
  buildTime.value = new Date().toLocaleDateString()
}

// Âä†ËΩΩÂΩìÂâçÊï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï
const loadCurrentDataPath = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.getCurrentDataPath()
      if (result.success) {
        currentDataPath.value = result.path || ''
        
        // ËæìÂá∫Ë∞ÉËØï‰ø°ÊÅØ
        console.log('Data path info:', {
          currentPath: result.path,
          userData: result.userData,
          imagesDir: result.imagesDir,
          imagesExists: result.imagesExists,
          imageCount: result.imageCount
        })
        
        // Â¶ÇÊûúÂõæÁâáÁõÆÂΩï‰∏çÂ≠òÂú®‰ΩÜÊúâÂõæÁâáÂÜÖÂÆπÔºåÊèêÁ§∫Áî®Êà∑
        if (!result.imagesExists && result.imageCount === 0) {
          console.warn('ÂõæÁâáÁõÆÂΩï‰∏çÂ≠òÂú®Êàñ‰∏∫Á©∫')
        }
      }
    }
  } catch (error) {
    console.error('Failed to load current data path:', error)
  }
}

// ÈÄâÊã©Êñ∞ÁöÑÊï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï
const selectNewDataDirectory = async () => {
  try {
    if (typeof window !== 'undefined' && window.db) {
      const result = await window.db.selectDataDirectory()
      if (result.success && result.path) {
        // Á°ÆËÆ§ËøÅÁßª
        if (confirm(`Á°ÆÂÆöË¶ÅÂ∞ÜÊï∞ÊçÆËøÅÁßªÂà∞‰ª•‰∏ãÁõÆÂΩïÂêóÔºü

${result.path}

Êï∞ÊçÆÂ∞ÜË¢´Â§çÂà∂Âà∞Êñ∞‰ΩçÁΩÆÔºåÂ∫îÁî®ÈúÄË¶ÅÈáçÂêØÂêéÁîüÊïà„ÄÇ`)) {
          const migrateResult = await window.db.migrateDataDirectory(result.path)
          if (migrateResult.success) {
            showMessage(migrateResult.message || 'Êï∞ÊçÆËøÅÁßªÊàêÂäü')
            currentDataPath.value = result.path
            
            // ÊèêÁ§∫Áî®Êà∑ÈáçÂêØÂ∫îÁî®
            setTimeout(() => {
              if (confirm('Êï∞ÊçÆËøÅÁßªÂÆåÊàêÔºåÊòØÂê¶Á´ãÂç≥ÈáçÂêØÂ∫îÁî®Ôºü')) {
                location.reload()
              }
            }, 1000)
          } else {
            showMessage('ËøÅÁßªÂ§±Ë¥•: ' + migrateResult.error, 'error')
          }
        }
      } else if (!result.canceled) {
        showMessage('ÈÄâÊã©ÁõÆÂΩïÂ§±Ë¥•', 'error')
      }
    } else {
      showMessage('Web ÁéØÂ¢É‰∏çÊîØÊåÅÊ≠§ÂäüËÉΩ', 'warning')
    }
  } catch (error) {
    console.error('Select data directory error:', error)
    showMessage('ÈÄâÊã©ÁõÆÂΩïÂ§±Ë¥•', 'error')
  }
}

// ÊâìÂºÄÊï∞ÊçÆÂ≠òÂÇ®ÁõÆÂΩï
const openDataDirectory = async () => {
  if (currentDataPath.value) {
    try {
      if (typeof window !== 'undefined' && window.db) {
        const result = await window.db.openDirectory(currentDataPath.value)
        if (!result.success) {
          showMessage('ÊâìÂºÄÁõÆÂΩïÂ§±Ë¥•', 'error')
        }
      } else {
        // Web ÁéØÂ¢ÉÂ§çÂà∂Ë∑ØÂæÑÂà∞Ââ™Ë¥¥Êùø
        navigator.clipboard?.writeText(currentDataPath.value)
        showMessage('Ë∑ØÂæÑÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
      }
    } catch (error) {
      console.error('Open directory error:', error)
      showMessage('ÊâìÂºÄÁõÆÂΩïÂ§±Ë¥•', 'error')
    }
  }
}
</script>

<style scoped>
/* Â∫îÁî®‰∏ªÂÆπÂô® */
.app {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--bg-color);
  color: var(--text-color);
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* ‰∏ªÈ¢òÂèòÈáèÂÆö‰πâ */
.app[data-theme="light"] {
  --bg-color: #f5f5f5;
  --text-color: #333;
  --toolbar-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --toolbar-text: #fff;
  --border-color: #e0e0e0;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  --radius: 8px;
}

.app[data-theme="dark"] {
  --bg-color: #1a1a1a;
  --text-color: #e0e0e0;
  --toolbar-bg: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
  --toolbar-text: #fff;
  --border-color: #333;
  --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  --radius: 8px;
}

/* Â∑•ÂÖ∑Ê†èÊ†∑Âºè */
.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: var(--toolbar-bg);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.app-title {
  font-size: 20px;
  font-weight: 600;
  color: var(--toolbar-text);
  margin: 0;
}

.toolbar-right {
  display: flex;
  gap: 8px;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.main-content {
  flex: 1;
  padding: 20px;
  overflow: hidden;
}

/* ÂõõË±°ÈôêÁΩëÊ†ºÂ∏ÉÂ±Ä */
.quadrant-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;
  gap: 20px;
  height: 100%;
}

/* Ë±°ÈôêÊ†∑Âºè */
.quadrant {
  background: rgba(255, 255, 255, 0.9);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: all 0.3s ease;
  position: relative;
}

.quadrant.drag-over {
  background: rgba(135, 206, 250, 0.15);
  border: 2px dashed #4CAF50;
  transform: scale(1.02);
}

[data-theme="dark"] .quadrant {
  background: rgba(42, 42, 42, 0.9);
  border: 1px solid var(--border-color);
}

[data-theme="dark"] .quadrant.drag-over {
  background: rgba(76, 175, 80, 0.15);
  border: 2px dashed #4CAF50;
}

/* Ë±°ÈôêÁâπÂÆöÈ¢úËâ≤ */
.urgent-important {
  border-left: 4px solid #ff4757;
}

.important-not-urgent {
  border-left: 4px solid #3742fa;
}

.urgent-not-important {
  border-left: 4px solid #ffa502;
}

.not-urgent-not-important {
  border-left: 4px solid #2ed573;
}

/* Ë±°ÈôêÂ§¥ÈÉ® */
.quadrant-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border-color);
}

.quadrant-header h2 {
  font-size: 16px;
  font-weight: 600;
  margin: 0;
  color: var(--text-color);
}

/* Ê∑ªÂä†ÊåâÈíÆÊ†∑Âºè */
.add-button {
  font-size: 18px !important;
  font-weight: bold !important;
  min-width: 32px !important;
  height: 32px !important;
  border-radius: 50% !important;
  transition: all 0.2s ease !important;
}

.add-button:hover {
  transform: scale(1.1) !important;
  background: rgba(64, 169, 255, 0.1) !important;
}

[data-theme="dark"] .add-button {
  color: #e0e0e0 !important;
  background: rgba(255, 255, 255, 0.05) !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

[data-theme="dark"] .add-button:hover {
  background: rgba(255, 255, 255, 0.15) !important;
  border-color: rgba(255, 255, 255, 0.3) !important;
  color: #fff !important;
}

/* Â§áÂøòÂΩïÂàóË°® */
.memo-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 4px;
}

/* Â§áÂøòÂΩïÂ§¥ÈÉ®Â∏ÉÂ±Ä */
.memo-header {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 8px;
}

/* Â§áÂøòÂΩïÂç°Áâá */
.memo-card {
  background: white;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  position: relative;
  user-select: none;
}

.memo-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.memo-card.dragging {
  opacity: 0.3;
  transform: rotate(2deg) scale(0.95);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
  z-index: 1000;
  pointer-events: none;
}

.memo-card.long-pressed {
  background: rgba(135, 206, 250, 0.2);
  transform: scale(1.02);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  cursor: grabbing !important;
}

[data-theme="dark"] .memo-card.long-pressed {
  background: rgba(76, 175, 80, 0.2);
}

[data-theme="dark"] .memo-card {
  background: rgba(60, 60, 60, 0.8);
  border-color: var(--border-color);
}

[data-theme="dark"] .memo-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Â§áÂøòÂΩïÂç°ÁâáÈ¢úËâ≤Âèò‰Ωì */
.urgent-important-card {
  border-left: 3px solid #ff4757;
}

.important-not-urgent-card {
  border-left: 3px solid #3742fa;
}

.urgent-not-important-card {
  border-left: 3px solid #ffa502;
}

.not-urgent-not-important-card {
  border-left: 3px solid #2ed573;
}

/* Â§áÂøòÂΩïÊ†áÈ¢ò */
.memo-title {
  font-weight: 600;
  font-size: 14px;
  line-height: 1.4;
  color: var(--text-color);
  flex: 1;
  word-break: break-word;
}

[data-theme="dark"] .memo-title {
  color: #f0f0f0;
}

/* Â∑≤ÂÆåÊàêÁöÑÊñáÂ≠óÊ†∑Âºè */
.completed-text {
  color: #999 !important;
  text-decoration: line-through;
}

[data-theme="dark"] .completed-text {
  color: #666 !important;
}

/* Â∑≤ÂÆåÊàêÁöÑÂç°ÁâáÊ†∑Âºè */
.memo-card.completed {
  opacity: 0.7;
  background: rgba(0, 0, 0, 0.03);
}

[data-theme="dark"] .memo-card.completed {
  background: rgba(255, 255, 255, 0.03);
}

/* Â§áÂøòÂΩïÈ¢ÑËßà */
.memo-preview {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
  margin-bottom: 8px;
}

[data-theme="light"] .memo-preview {
  color: #666;
}

[data-theme="dark"] .memo-preview {
  color: #bbb;
}

/* Â§áÂøòÂΩïÊìç‰ΩúÊåâÈíÆ */
.memo-actions {
  display: flex;
  justify-content: flex-end;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.memo-card:hover .memo-actions {
  opacity: 1;
}

/* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
.modal-content {
  padding: 0;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* Êï∞ÊçÆÁÆ°ÁêÜÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
.data-manage-content {
  padding: 0;
}

.data-section h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color);
}

.data-section p {
  margin: 0 0 12px 0;
  color: #666;
  font-size: 14px;
  line-height: 1.5;
}

[data-theme="light"] .data-section p {
  color: #666;
}

[data-theme="dark"] .data-section p {
  color: #bbb;
}

.danger-section {
  background: rgba(255, 71, 87, 0.05);
  padding: 16px;
  border-radius: 6px;
  border: 1px solid rgba(255, 71, 87, 0.2);
}

[data-theme="dark"] .danger-section {
  background: rgba(255, 71, 87, 0.1);
  border-color: rgba(255, 71, 87, 0.3);
}

.import-text-content {
  padding: 0;
}

/* Â∑≤ÂÆåÊàêÂæÖÂäûÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
.completed-memo-content {
  padding: 0;
  max-height: calc(80vh - 200px);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #999;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.empty-icon {
  font-size: 64px;
  margin-bottom: 20px;
  opacity: 0.5;
}

.completed-memo-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 8px;
}

.completed-memo-item {
  background: rgba(255, 255, 255, 0.8);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 8px;
  border: 1px solid var(--border-color);
  transition: all 0.2s ease;
}

.completed-memo-item:hover {
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .completed-memo-item {
  background: rgba(60, 60, 60, 0.8);
  border-color: #434343;
}

[data-theme="dark"] .completed-memo-item:hover {
  background: rgba(60, 60, 60, 0.9);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.completed-memo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.completed-memo-title {
  font-weight: 600;
  font-size: 16px;
  color: var(--text-color);
  text-decoration: line-through;
  opacity: 0.8;
  flex: 1;
  margin-right: 16px;
}

.completed-memo-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.completed-time {
  font-size: 12px;
  color: #999;
  white-space: nowrap;
}

.quadrant-tag {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  color: white;
  font-weight: 500;
  white-space: nowrap;
}

.quadrant-tag.urgent-important {
  background: #ff4757;
}

.quadrant-tag.important-not-urgent {
  background: #3742fa;
}

.quadrant-tag.urgent-not-important {
  background: #ffa502;
}

.quadrant-tag.not-urgent-not-important {
  background: #2ed573;
}



.completed-memo-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 8px;
}

/* Â∑≤ÂÆåÊàêÂæÖÂäûËØ¶ÊÉÖÊ†∑Âºè */
.completed-detail-content {
  padding: 0;
}

.detail-section {
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #f0f0f0;
}

.detail-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.detail-section h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

[data-theme="dark"] .detail-section h4 {
  color: #bbb;
}

[data-theme="dark"] .detail-section {
  border-bottom-color: #333;
}

.detail-title {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-color);
  line-height: 1.4;
}

.detail-time,
.detail-created {
  margin: 0;
  font-size: 14px;
  color: #666;
}

[data-theme="dark"] .detail-time,
[data-theme="dark"] .detail-created {
  color: #bbb;
}

.detail-content {
  background: rgba(0, 0, 0, 0.02);
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  padding: 16px;
  line-height: 1.6;
  font-size: 14px;
  color: var(--text-color);
  max-height: 300px;
  overflow-y: auto;
}

[data-theme="dark"] .detail-content {
  background: rgba(255, 255, 255, 0.02);
  border-color: #333;
}

.detail-content img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  margin: 8px 0;
}

.completed-memo-item {
  cursor: pointer;
  transition: all 0.2s ease;
}

.completed-memo-item:hover {
  background: rgba(255, 255, 255, 0.95) !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

[data-theme="dark"] .completed-memo-item:hover {
  background: rgba(60, 60, 60, 0.95) !important;
}

/* ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
.settings-content {
  padding: 0;
}

.settings-section {
  padding: 16px 0;
}

.settings-section h3 {
  margin: 0 0 16px 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-color);
}

.version-info {
  background: rgba(0, 0, 0, 0.02);
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  padding: 16px;
  font-size: 14px;
  line-height: 1.6;
}

[data-theme="dark"] .version-info {
  background: rgba(255, 255, 255, 0.02);
  border-color: #333;
}

.version-info p {
  margin: 0 0 8px 0;
}

.version-info p:last-child {
  margin-bottom: 0;
}

.data-path-section {
  line-height: 1.6;
}

.data-path-section p {
  margin: 0 0 12px 0;
  font-size: 14px;
}

.current-path {
  margin-bottom: 12px;
}

.setting-description {
  font-size: 12px;
  color: #666;
  line-height: 1.4;
  margin-top: 8px !important;
}

[data-theme="dark"] .setting-description {
  color: #bbb;
}

/* ÂØåÊñáÊú¨ÁºñËæëÂô®Ê†∑Âºè */
.rich-editor-container {
  width: 100%;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.rich-editor {
  width: 100%;
  min-height: 250px;
  max-height: 450px;
  padding: 12px;
  overflow-y: auto;
  background: white;
  line-height: 1.6;
  outline: none;
  border: none;
  box-sizing: border-box;
  word-wrap: break-word;
}

.rich-editor:focus {
  outline: none;
}

.rich-editor-container:focus-within {
  border-color: #40a9ff;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

[data-theme="dark"] .rich-editor {
  background: rgba(255, 255, 255, 0.05);
  color: #e0e0e0;
}

[data-theme="dark"] .rich-editor-container {
  border-color: #434343;
}

[data-theme="dark"] .rich-editor-container:focus-within {
  border-color: #177ddc;
  box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
}

.rich-editor img {
  max-width: 100%;
  height: auto;
  margin: 8px 0;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* ÂèØË∞ÉÊï¥Â§ßÂ∞èÁöÑÂõæÁâáÂÆπÂô® */
.resizable-image-container {
  position: relative;
  display: inline-block;
  margin: 0 4px;
  border: 2px solid transparent;
  border-radius: 4px;
  transition: border-color 0.2s ease;
  vertical-align: top;
  max-width: fit-content;
}

.resizable-image-container:hover {
  border-color: rgba(64, 169, 255, 0.3) !important;
}

.resizable-image-container img {
  display: inline-block;
  margin: 0;
  cursor: pointer;
  vertical-align: top;
  border-radius: 4px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

.resize-handle {
  position: absolute;
  bottom: -5px;
  right: -5px;
  width: 10px;
  height: 10px;
  background: #40a9ff;
  border: 2px solid white;
  border-radius: 50%;
  cursor: nw-resize;
  display: none;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.resize-handle:hover {
  background: #1890ff;
  transform: scale(1.2);
}

.editor-toolbar {
  background: rgba(0, 0, 0, 0.02);
  padding: 8px 12px;
  border-top: 1px solid var(--border-color);
  font-size: 12px;
  color: #666;
}

[data-theme="dark"] .editor-toolbar {
  background: rgba(255, 255, 255, 0.02);
  color: #999;
}

/* TODO: Ê∑ªÂä†ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .quadrant-grid {
    grid-template-columns: 1fr;
    grid-template-rows: repeat(4, 1fr);
  }
  
  .main-content {
    padding: 10px;
  }
  
  .toolbar {
    padding: 8px 12px;
  }
}

/* ÂÖ®Â±ÄÊªöÂä®Êù°Ê†∑Âºè */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: transparent;
  border-radius: 3px;
  transition: all 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.35);
}

::-webkit-scrollbar-corner {
  background: transparent;
}

/* hover Êó∂ÊòæÁ§∫ÊªöÂä®Êù° */
*:hover::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.2);
}

*:hover::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
}

/* Ê∑±Ëâ≤‰∏ªÈ¢òÊªöÂä®Êù° */
[data-theme="dark"] ::-webkit-scrollbar-track {
  background: transparent;
}

[data-theme="dark"] ::-webkit-scrollbar-thumb {
  background: transparent;
}

[data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.35);
}

[data-theme="dark"] *:hover::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] *:hover::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
</style>